# Контроль внешних интеграций

## 1. Мониторинг ошибок
- Используйте централизованный модуль Asistent/services/integration_monitor.py (функции ecord_integration_error/record_integration_success).
- Алерты приходят в админский Telegram (prefix Integration). Повторные сообщения блокируются на INTEGRATION_ALERT_COOLDOWN_MINUTES (по умолчанию 30 минут).
- GigaChat и Telegram уже подключены: коды 401/402/403/429 и сетевые сбои автоматически сигналят.

## 2. Ретраи и backoff
- Telegram-клиент выполняет до 3 попыток при кодах 429/5xx, между повторами  экспоненциальная задержка.
- GigaChat остаётся с декоратором ate_limit_retry, дополнительно фиксируются 402/429.
- Для остальных интеграций при сетевых ошибках вызывайте ecord_integration_error и, при необходимости, повторяйте запрос со сном.

## 3. Действия при алертах
1. Откройте ссылку на лог/расписание (присутствует в уведомлении).
2. Проверьте причину: токены GigaChat (/asistent/api/gigachat-balance/), ошибки Telegram (logs/django.log), дисковое пространство (df -h).
3. После исправления перезапустите пайплайн/расписание (кнопка Повторить пайплайн или python manage.py run_pipeline_by_slug_task ...).
4. При критических проблемах поставьте расписание на паузу (Остановить) до восстановления сервиса.

## 4. Настройки
- INTEGRATION_ALERT_COOLDOWN_MINUTES  глобальный таймаут алертов.
- Остальные пороги: PIPELINE_* (см. pipelines.md), AISCHEDULE_MAX_ITEMS_PER_HOUR (ограничение нагрузки в UI).
- Переменные задаются в .env, требуется перезапуск Django/Q.
