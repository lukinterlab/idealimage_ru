{% extends 'donations/base_bonuses.html' %}
{% load static %}

{% block title %}–î–∞—à–±–æ—Ä–¥ –±–æ–Ω—É—Å–æ–≤ - –ê–¥–º–∏–Ω{% endblock %}

{% block bonuses_content %}
<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
            üí∞ –î–∞—à–±–æ—Ä–¥ –±–æ–Ω—É—Å–æ–≤ –∞–≤—Ç–æ—Ä–æ–≤
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
            –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: {{ week_start|date:"d.m.Y" }} - {{ week_end|date:"d.m.Y" }}
        </p>
    </div>
    <div class="flex gap-3">
        <a href="{% url 'donations:payment_registry' %}" 
           class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
            üìã –†–µ–µ—Å—Ç—Ä –≤—ã–ø–ª–∞—Ç
        </a>
        <a href="/admin/donations/weeklyreport/" 
           class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
            üìä –û—Ç—á–µ—Ç—ã
        </a>
        <a href="/admin/donations/" 
           class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
            ‚öôÔ∏è Django Admin
        </a>
    </div>
</div>

<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="stat-card border-l-4 border-blue-500">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤</p>
        <p class="text-4xl font-bold text-blue-600 dark:text-blue-400">
            {{ current_week.active_authors_count|default:0 }}
        </p>
    </div>
    
    <div class="stat-card border-l-4 border-green-500">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">–î–æ–Ω–∞—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</p>
        <p class="text-4xl font-bold text-green-600 dark:text-green-400">
            {{ current_week.total_donations|default:0|floatformat:2 }}‚ÇΩ
        </p>
        <p class="text-xs text-gray-500 mt-1">{{ current_week.donations_count|default:0 }} –ø–ª–∞—Ç–µ–∂–µ–π</p>
    </div>
    
    <div class="stat-card border-l-4 border-purple-500">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">–°—Ç–∞—Ç–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é</p>
        <p class="text-4xl font-bold text-purple-600 dark:text-purple-400">
            {{ current_week.authors_with_articles|default:0 }}
        </p>
    </div>
    
    <div class="stat-card border-l-4 border-orange-500">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">–ó–∞–¥–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
        <p class="text-4xl font-bold text-orange-600 dark:text-orange-400">
            {{ current_week.authors_with_tasks|default:0 }}
        </p>
    </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á–µ—Ç -->
{% if latest_report %}
<div class="stat-card mb-8 bg-gradient-to-r from-indigo-500 to-purple-600 text-white">
    <h3 class="text-xl font-bold mb-4">üìà –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <p class="opacity-75 text-sm">–ü–µ—Ä–∏–æ–¥</p>
            <p class="font-semibold">{{ latest_report.week_start|date:"d.m" }} - {{ latest_report.week_end|date:"d.m.Y" }}</p>
        </div>
        <div>
            <p class="opacity-75 text-sm">–ê–≤—Ç–æ—Ä–æ–≤</p>
            <p class="font-semibold text-2xl">{{ latest_report.authors_count }}</p>
        </div>
        <div>
            <p class="opacity-75 text-sm">–ë–æ–Ω—É—Å–æ–≤</p>
            <p class="font-semibold text-2xl">{{ latest_report.total_bonuses|floatformat:2 }}‚ÇΩ</p>
        </div>
        <div>
            <p class="opacity-75 text-sm">–°—Ç–∞—Ç—É—Å</p>
            <p class="font-semibold">
                {% if latest_report.is_paid %}‚úÖ –û–ø–ª–∞—á–µ–Ω{% else %}‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã{% endif %}
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º -->
<div class="stat-card mb-8">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">üë• –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–æ–≤ –ø–æ —Ä–æ–ª—è–º</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        {% for role_stat in roles_stats %}
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 text-center">
            <div class="w-12 h-12 rounded-full mx-auto mb-2 flex items-center justify-center" 
                 style="background-color: {{ role_stat.role.color }}20;">
                <span class="text-2xl">
                    {% if role_stat.role.level == 1 %}üå±
                    {% elif role_stat.role.level == 2 %}‚úçÔ∏è
                    {% elif role_stat.role.level == 3 %}üìö
                    {% else %}üèÜ{% endif %}
                </span>
            </div>
            <p class="font-semibold text-gray-900 dark:text-white">{{ role_stat.role.name }}</p>
            <p class="text-2xl font-bold" style="color: {{ role_stat.role.color }};">{{ role_stat.authors_count }}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ role_stat.role.bonus_percentage }}% –æ—Ç –¥–æ–Ω–∞—Ç–æ–≤</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∞–≤—Ç–æ—Ä–æ–≤ -->
<div class="stat-card mb-8">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ—Ä–æ–≤ –∑–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é</h3>
    {% if authors_stats %}
    <div class="overflow-x-auto">
        <table class="dashboard-table">
            <thead>
                <tr>
                    <th>–ê–≤—Ç–æ—Ä</th>
                    <th>–†–æ–ª—å</th>
                    <th>–°—Ç–∞—Ç—å–∏</th>
                    <th>–õ–∞–π–∫–∏</th>
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</th>
                    <th>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
                    <th>–ó–∞–¥–∞–Ω–∏—è</th>
                    <th>–ë–∞–ª–ª—ã</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for stats in authors_stats %}
                <tr>
                    <td class="font-semibold">
                        <a href="/admin/auth/user/{{ stats.author.id }}/change/" target="_blank"
                           class="text-purple-600 dark:text-purple-400 hover:underline">
                            {{ stats.author.get_full_name|default:stats.author.username }}
                        </a>
                    </td>
                    <td>
                        {% if stats.current_role %}
                        <span class="role-badge" style="background-color: {{ stats.current_role.color }}20; color: {{ stats.current_role.color }};">
                            {{ stats.current_role.name }}
                        </span>
                        {% else %}
                        <span class="role-badge bg-gray-100 text-gray-600">–°—Ç–∞–∂—ë—Ä</span>
                        {% endif %}
                    </td>
                    <td>{{ stats.articles_count }}</td>
                    <td>{{ stats.total_likes }}</td>
                    <td>{{ stats.total_comments }}</td>
                    <td>{{ stats.total_views }}</td>
                    <td>{{ stats.completed_tasks_count }}</td>
                    <td class="font-bold text-yellow-600 dark:text-yellow-400">{{ stats.calculated_points|floatformat:1 }}</td>
                    <td>
                        <button onclick="showAuthorDetails({{ stats.author.id }})" 
                                class="text-purple-600 dark:text-purple-400 hover:underline text-sm">
                            –î–µ—Ç–∞–ª–∏
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center py-8 text-gray-500 dark:text-gray-400">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –∑–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é</p>
    {% endif %}
</div>

<!-- –î–æ–Ω–∞—Ç—ã –∑–∞ –Ω–µ–¥–µ–ª—é -->
<div class="stat-card mb-8">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">üíù –î–æ–Ω–∞—Ç—ã –∑–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é</h3>
    {% if week_donations %}
    <div class="overflow-x-auto">
        <table class="dashboard-table">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–î–æ–Ω–∞—Ç–µ—Ä</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–°—Ç–∞—Ç—å—è</th>
                    <th>–ê–≤—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏</th>
                </tr>
            </thead>
            <tbody>
                {% for donation in week_donations|slice:":20" %}
                <tr>
                    <td>{{ donation.completed_at|date:"d.m.Y H:i" }}</td>
                    <td>{{ donation.get_donor_name|truncatechars:30 }}</td>
                    <td class="font-semibold text-green-600 dark:text-green-400">{{ donation.amount }}‚ÇΩ</td>
                    <td>
                        {% if donation.article %}
                        <a href="{% url 'blog:post_detail' donation.article.slug %}" target="_blank"
                           class="text-purple-600 dark:text-purple-400 hover:underline">
                            {{ donation.article.title|truncatechars:40 }}
                        </a>
                        {% else %}
                        <span class="text-gray-500">–û–±—â–∏–π –¥–æ–Ω–∞—Ç</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if donation.article_author %}
                        <a href="/admin/auth/user/{{ donation.article_author.id }}/change/" target="_blank"
                           class="text-purple-600 dark:text-purple-400 hover:underline">
                            {{ donation.article_author.get_full_name|default:donation.article_author.username }}
                        </a>
                        {% else %}-{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if week_donations.count > 20 %}
    <p class="text-center mt-4 text-gray-500 dark:text-gray-400 text-sm">
        ...–∏ –µ—â—ë {{ week_donations.count|add:"-20" }} –¥–æ–Ω–∞—Ç–æ–≤
    </p>
    {% endif %}
    {% else %}
    <p class="text-center py-8 text-gray-500 dark:text-gray-400">–ù–µ—Ç –¥–æ–Ω–∞—Ç–æ–≤ –∑–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é</p>
    {% endif %}
</div>

<!-- –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã -->
{% if pending_payments %}
<div class="stat-card mb-8 border-l-4 border-orange-500">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">‚è≥ –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã</h3>
    <div class="overflow-x-auto">
        <table class="dashboard-table">
            <thead>
                <tr>
                    <th>–ê–≤—Ç–æ—Ä</th>
                    <th>–ü–µ—Ä–∏–æ–¥</th>
                    <th>–ö –≤—ã–ø–ª–∞—Ç–µ</th>
                    <th>–í—ã–ø–ª–∞—á–µ–Ω–æ</th>
                    <th>–û—Å—Ç–∞–ª–æ—Å—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in pending_payments %}
                <tr>
                    <td class="font-semibold">{{ payment.author.get_full_name|default:payment.author.username }}</td>
                    <td>{{ payment.week_report.week_start|date:"d.m" }} - {{ payment.week_report.week_end|date:"d.m.Y" }}</td>
                    <td class="font-semibold">{{ payment.amount_to_pay }}‚ÇΩ</td>
                    <td class="text-green-600 dark:text-green-400">{{ payment.paid_amount }}‚ÇΩ</td>
                    <td class="text-orange-600 dark:text-orange-400 font-semibold">
                        {{ payment.amount_to_pay|add:"-"|add:payment.paid_amount }}‚ÇΩ
                    </td>
                    <td>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold
                            {% if payment.status == 'pending' %}bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400
                            {% elif payment.status == 'partial' %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400
                            {% endif %}">
                            {{ payment.get_status_display }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="mt-4 text-center">
        <a href="{% url 'donations:payment_registry' %}" 
           class="inline-flex items-center px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition-colors">
            –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–ø–ª–∞—Ç—ã ‚Üí
        </a>
    </div>
</div>
{% endif %}

<!-- –ù–µ–¥–∞–≤–Ω–∏–µ —à—Ç—Ä–∞—Ñ—ã –∏ –ø—Ä–µ–º–∏–∏ -->
{% if recent_adjustments %}
<div class="stat-card mb-8">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">‚öñÔ∏è –ù–µ–¥–∞–≤–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</h3>
    <div class="space-y-3">
        {% for adj in recent_adjustments %}
        <div class="flex items-center justify-between p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold
                        {% if adj.type == 'penalty' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400
                        {% else %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400{% endif %}">
                        {% if adj.type == 'penalty' %}–®—Ç—Ä–∞—Ñ{% else %}–ü—Ä–µ–º–∏—è{% endif %}
                    </span>
                    <span class="font-semibold text-gray-900 dark:text-white">
                        {{ adj.author.get_full_name|default:adj.author.username }}
                    </span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">{{ adj.reason|truncatechars:100 }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                    {{ adj.get_applied_to_display }} | –°–æ–∑–¥–∞–ª: {{ adj.created_by.username|default:"AI –ê–≥–µ–Ω—Ç" }}
                </p>
            </div>
            <div class="text-right ml-4">
                <p class="text-xl font-bold {% if adj.type == 'penalty' %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %}">
                    {% if adj.type == 'penalty' %}-{% else %}+{% endif %}{{ adj.amount }}{% if adj.amount_type == 'percentage' %}%{% else %}‚ÇΩ{% endif %}
                </p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- –í–∏–¥–∂–µ—Ç —Ä–æ–ª–µ–π –∏ —Ñ–æ—Ä–º—É–ª -->
<div class="stat-card mb-8">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">üíé –†–æ–ª–∏ –∏ —Ñ–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π —Ä–∞–Ω–≥–æ–≤ –∏ –≤–µ—Å–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
        </div>
        <button onclick="openCreateRoleModal()"
                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
            + –ù–æ–≤–∞—è —Ä–æ–ª—å
        </button>
    </div>
    
    <div id="rolesWidget" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for role in all_roles %}
        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border-2 hover:border-purple-500 dark:hover:border-purple-400 transition-colors cursor-pointer"
             onclick="openRoleModal({{ role.id }})"
             data-role-id="{{ role.id }}">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–æ–ª–∏ -->
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full" style="background-color: {{ role.color }}"></div>
                    <h4 class="font-bold text-gray-900 dark:text-white">{{ role.name }}</h4>
                </div>
                <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">
                    –£—Ä. {{ role.level }}
                </span>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">–û—Ç –¥–æ–Ω–∞—Ç–æ–≤:</span>
                    <span class="font-semibold text-gray-900 dark:text-white">{{ role.bonus_percentage }}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">–°—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–ª–ª–∞:</span>
                    <span class="font-semibold text-gray-900 dark:text-white">{{ role.point_value }}‚ÇΩ</span>
                </div>
                
                {% if role.formula %}
                <div class="pt-2 mt-2 border-t border-gray-200 dark:border-gray-700">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">–í–µ—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</p>
                    <div class="grid grid-cols-2 gap-1 text-xs">
                        <span class="text-gray-600 dark:text-gray-400">üìù {{ role.formula.articles_weight }}</span>
                        <span class="text-gray-600 dark:text-gray-400">‚ù§Ô∏è {{ role.formula.likes_weight }}</span>
                        <span class="text-gray-600 dark:text-gray-400">üí¨ {{ role.formula.comments_weight }}</span>
                        <span class="text-gray-600 dark:text-gray-400">‚úÖ {{ role.formula.tasks_weight }}</span>
                    </div>
                </div>
                {% else %}
                <div class="pt-2 mt-2 border-t border-gray-200 dark:border-gray-700">
                    <p class="text-xs text-orange-600 dark:text-orange-400">‚ö†Ô∏è –§–æ—Ä–º—É–ª–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">
            –†–æ–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "+ –ù–æ–≤–∞—è —Ä–æ–ª—å" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–æ–Ω—É—Å–æ–≤ –∞–≤—Ç–æ—Ä–∞ -->
<div class="stat-card mb-8">
    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-xl p-8">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center flex items-center justify-center gap-2">
            <span class="text-3xl">üí∞</span>
            –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ—Ö–æ–¥–∞ –∞–≤—Ç–æ—Ä–∞ (–Ω–µ–¥–µ–ª—è)
        </h3>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
            <div class="space-y-4">
                <!-- –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 dark:text-gray-300 mb-2">
                        üèÜ –†–æ–ª—å –∞–≤—Ç–æ—Ä–∞
                    </label>
                    <select id="bonus-calc-role" 
                            class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-center text-lg font-semibold"
                            onchange="updateBonusCalculator()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å...</option>
                        {% for role in all_roles %}
                        <option value="{{ role.id }}" 
                                data-point-value="{{ role.point_value }}"
                                data-articles-weight="{{ role.formula.articles_weight|default:10 }}"
                                data-likes-weight="{{ role.formula.likes_weight|default:0.5 }}"
                                data-comments-weight="{{ role.formula.comments_weight|default:1 }}"
                                data-views-weight="{{ role.formula.views_weight|default:0.01 }}"
                                data-tasks-weight="{{ role.formula.tasks_weight|default:5 }}">
                            {{ role.name }} (1 –±–∞–ª–ª = {{ role.point_value }}‚ÇΩ)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- –°—Ç–∞—Ç–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 dark:text-gray-300 mb-2">
                        üìù –°—Ç–∞—Ç–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é
                    </label>
                    <input type="number" id="bonus-calc-articles" value="10" min="0" max="100"
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-center text-xl font-bold"
                           oninput="calculateBonus()">
                </div>
                
                <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–æ–±—â–µ–µ) -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 dark:text-gray-300 mb-2">
                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–≤—Å–µ–≥–æ –∑–∞ –Ω–µ–¥–µ–ª—é)
                    </label>
                    <input type="number" id="bonus-calc-views" value="5000" min="0" max="1000000" step="100"
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-center text-xl font-bold"
                           oninput="calculateBonus()">
                </div>
                
                <!-- –õ–∞–π–∫–æ–≤ (–æ–±—â–µ–µ) -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 dark:text-gray-300 mb-2">
                        ‚ù§Ô∏è –õ–∞–π–∫–æ–≤ (–≤—Å–µ–≥–æ –∑–∞ –Ω–µ–¥–µ–ª—é)
                    </label>
                    <input type="number" id="bonus-calc-likes" value="500" min="0" max="50000" step="10"
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-center text-xl font-bold"
                           oninput="calculateBonus()">
                </div>
                
                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–æ–±—â–µ–µ) -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 dark:text-gray-300 mb-2">
                        üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–≤—Å–µ–≥–æ –∑–∞ –Ω–µ–¥–µ–ª—é)
                    </label>
                    <input type="number" id="bonus-calc-comments" value="300" min="0" max="50000" step="10"
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-center text-xl font-bold"
                           oninput="calculateBonus()">
                </div>
                
                <!-- –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 dark:text-gray-300 mb-2">
                        ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π
                    </label>
                    <input type="number" id="bonus-calc-tasks" value="5" min="0" max="100"
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-center text-xl font-bold"
                           oninput="calculateBonus()">
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            <div class="space-y-4">
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞ -->
                <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-8 text-white text-center">
                    <p class="text-sm opacity-90 mb-2">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –∑–∞ –Ω–µ–¥–µ–ª—é</p>
                    <p class="text-5xl font-bold mb-2" id="bonus-result">0‚ÇΩ</p>
                    <p class="text-sm opacity-75">–¢–æ–ª—å–∫–æ –±–∞–ª–ª—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                </div>
                
                <!-- –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞ -->
                <div class="p-6 bg-blue-50 dark:bg-blue-900/20 rounded-lg space-y-3">
                    <h4 class="font-bold text-gray-900 dark:text-white mb-3">üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞</h4>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 dark:text-gray-300">üìù –ó–∞ —Å—Ç–∞—Ç—å–∏:</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="bonus-detail-articles">0 –±–∞–ª–ª–æ–≤</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 dark:text-gray-300">üëÅÔ∏è –ó–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã:</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="bonus-detail-views">0 –±–∞–ª–ª–æ–≤</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 dark:text-gray-300">‚ù§Ô∏è –ó–∞ –ª–∞–π–∫–∏:</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="bonus-detail-likes">0 –±–∞–ª–ª–æ–≤</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 dark:text-gray-300">üí¨ –ó–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="bonus-detail-comments">0 –±–∞–ª–ª–æ–≤</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 dark:text-gray-300">‚úÖ –ó–∞ –∑–∞–¥–∞–Ω–∏—è:</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="bonus-detail-tasks">0 –±–∞–ª–ª–æ–≤</span>
                        </div>
                        
                        <div class="border-t-2 border-gray-300 dark:border-gray-600 pt-2 mt-3">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-gray-900 dark:text-white">–ò–¢–û–ì–û –±–∞–ª–ª–æ–≤:</span>
                                <span class="font-bold text-blue-600 dark:text-blue-400 text-lg" id="bonus-detail-total">0</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-gray-700 dark:text-gray-300">–°—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–ª–ª–∞:</span>
                                <span class="font-bold text-gray-900 dark:text-white" id="bonus-detail-rate">0‚ÇΩ</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –§–æ—Ä–º—É–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–æ–ª–∏ -->
                <div id="bonus-formula-display" class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg hidden">
                    <p class="text-sm text-purple-900 dark:text-purple-300 font-semibold mb-2">
                        üí° –§–æ—Ä–º—É–ª–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–æ–ª–∏:
                    </p>
                    <div class="text-xs text-purple-800 dark:text-purple-200 space-y-1">
                        <div>üìù –°—Ç–∞—Ç—å—è = <span id="formula-articles">10</span> –±–∞–ª–ª–æ–≤</div>
                        <div>üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä = <span id="formula-views">0.01</span> –±–∞–ª–ª–∞</div>
                        <div>‚ù§Ô∏è –õ–∞–π–∫ = <span id="formula-likes">0.5</span> –±–∞–ª–ª–∞</div>
                        <div>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π = <span id="formula-comments">1</span> –±–∞–ª–ª</div>
                        <div>‚úÖ –ó–∞–¥–∞–Ω–∏–µ = <span id="formula-tasks">5</span> –±–∞–ª–ª–æ–≤</div>
                    </div>
                </div>
                
                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
                <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                    <p class="text-xs text-yellow-900 dark:text-yellow-200">
                        ‚ÑπÔ∏è <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –≠—Ç–æ –±–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. 
                        –ö –Ω–µ–º—É –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–æ–Ω–∞—Ç—ã –æ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π, –ø—Ä–µ–º–∏–∏ –∏ –≤—ã—á–∏—Ç–∞—Ç—å—Å—è —à—Ç—Ä–∞—Ñ—ã.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –í–∏–¥–∂–µ—Ç —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –ø—Ä–µ–º–∏–π (–∞–∫–∫–æ—Ä–¥–µ–æ–Ω) -->
<div class="stat-card mb-8">
    <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="togglePenaltiesAccordion()">
        <div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <svg id="penaltiesAccordionIcon" class="w-6 h-6 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                ‚ö° –®—Ç—Ä–∞—Ñ—ã –∏ –ü—Ä–µ–º–∏–∏
            </h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞–º–∏ –±–æ–Ω—É—Å–æ–≤ –∞–≤—Ç–æ—Ä–æ–≤</p>
        </div>
        <button onclick="event.stopPropagation(); openCreatePenaltyModal()"
                class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
            + –î–æ–±–∞–≤–∏—Ç—å
        </button>
    </div>
    
    <div id="penaltiesAccordionContent" class="hidden mt-4">
        <div id="penaltiesWidget" class="space-y-3">
            <!-- –°–ø–∏—Å–æ–∫ —à—Ç—Ä–∞—Ñ–æ–≤/–ø—Ä–µ–º–∏–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="grid grid-cols-1 gap-6 mb-8">
    <div class="stat-card text-center cursor-pointer hover:scale-105 transition-transform"
         onclick="generateWeeklyReport()">
        <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full mx-auto mb-4 flex items-center justify-center">
            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">–°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç</h4>
        <p class="text-sm text-gray-600 dark:text-gray-400">–ó–∞ –ø—Ä–æ—à–ª—É—é –Ω–µ–¥–µ–ª—é</p>
    </div>
</div>

<!-- –°—Å—ã–ª–∫–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª—ã -->
<div class="flex justify-center gap-4">
    <a href="/asistent/admin-panel/" 
       class="inline-flex items-center px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors">
        ü§ñ AI –∏ –∑–∞–¥–∞–Ω–∏—è
    </a>
    <a href="/admin/" 
       class="inline-flex items-center px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
        ‚öôÔ∏è Django Admin
    </a>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–∏ -->
<div id="roleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModals(event)">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white" id="roleModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏</h2>
            <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="roleForm" class="space-y-6">
            <input type="hidden" id="roleId" name="roleId">
            
            <!-- –°–µ–∫—Ü–∏—è: –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–æ–ª–∏ -->
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üìå –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏</label>
                        <input type="text" id="roleName" name="name" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–£—Ä–æ–≤–µ–Ω—å (1-4)</label>
                        <input type="number" id="roleLevel" name="level" min="1" max="10" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¥–æ–Ω–∞—Ç–æ–≤ (%)</label>
                        <input type="number" id="roleBonusPercentage" name="bonus_percentage" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–°—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–ª–ª–∞ (‚ÇΩ)</label>
                        <input type="number" id="rolePointValue" name="point_value" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¶–≤–µ—Ç —Ä–æ–ª–∏</label>
                        <input type="color" id="roleColor" name="color"
                               class="w-full h-10 px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="roleDescription" name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è: –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ -->
            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">‚öôÔ∏è –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">üìù –í–µ—Å —Å—Ç–∞—Ç—å–∏</label>
                        <input type="number" id="articlesWeight" name="articles_weight" step="0.1" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‚ù§Ô∏è –í–µ—Å –ª–∞–π–∫–∞</label>
                        <input type="number" id="likesWeight" name="likes_weight" step="0.1" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">üí¨ –í–µ—Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</label>
                        <input type="number" id="commentsWeight" name="comments_weight" step="0.1" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">üëÅÔ∏è –í–µ—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</label>
                        <input type="number" id="viewsWeight" name="views_weight" step="0.001" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‚úÖ –í–µ—Å –∑–∞–¥–∞–Ω–∏—è</label>
                        <input type="number" id="tasksWeight" name="tasks_weight" step="0.1" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ú–∏–Ω–∏–º—É–º –±–∞–ª–ª–æ–≤ (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)</label>
                        <input type="number" id="minPointsRequired" name="min_points_required" step="0.1" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ú–∏–Ω–∏–º—É–º —Å—Ç–∞—Ç–µ–π (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)</label>
                        <input type="number" id="minArticlesRequired" name="min_articles_required" min="0"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="flex justify-between gap-4">
                <button type="button" onclick="deleteRole()" id="deleteRoleBtn"
                        class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å
                </button>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModals()"
                            class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit"
                            class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–∏ -->
<div id="createRoleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModals(event)">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–æ–ª—å</h2>
            <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="createRoleForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ *</label>
                    <input type="text" name="name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–∞–∂—ë—Ä"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–£—Ä–æ–≤–µ–Ω—å *</label>
                    <input type="number" name="level" min="1" max="10" required placeholder="1"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¥–æ–Ω–∞—Ç–æ–≤ (%)</label>
                    <input type="number" name="bonus_percentage" step="0.01" min="0" placeholder="10.00"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–°—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–ª–ª–∞ (‚ÇΩ)</label>
                    <input type="number" name="point_value" step="0.01" min="0" placeholder="1.00"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¶–≤–µ—Ç</label>
                    <input type="color" name="color" value="#6B7280"
                           class="w-full h-10 px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" onclick="closeModals()"
                        class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                    ‚ú® –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞/–ø—Ä–µ–º–∏–∏ -->
<div id="createPenaltyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModals(event)">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">–î–æ–±–∞–≤–∏—Ç—å —à—Ç—Ä–∞—Ñ/–ø—Ä–µ–º–∏—é</h2>
            <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="createPenaltyForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ê–≤—Ç–æ—Ä *</label>
                    <select name="author_id" required id="penaltyAuthorSelect"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¢–∏–ø *</label>
                    <select name="type" required
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="penalty">–®—Ç—Ä–∞—Ñ</option>
                        <option value="reward">–ü—Ä–µ–º–∏—è</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¢–∏–ø —Å—É–º–º—ã *</label>
                    <select name="amount_type" required
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ (‚ÇΩ)</option>
                        <option value="percentage">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –±–æ–Ω—É—Å–∞ (%)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–°—É–º–º–∞ *</label>
                    <input type="number" name="amount" step="0.01" min="0" required placeholder="100.00"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ *</label>
                    <select name="applied_to" required
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="one_time">–†–∞–∑–æ–≤—ã–π</option>
                        <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π</option>
                        <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–∏—á–∏–Ω–∞ *</label>
                    <textarea name="reason" required rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —à—Ç—Ä–∞—Ñ–∞/–ø—Ä–µ–º–∏–∏..."
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" onclick="closeModals()"
                        class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
                    ‚úÖ –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞/–ø—Ä–µ–º–∏–∏ -->
<div id="editPenaltyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModals(event)">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white" id="editPenaltyTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h2>
            <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="editPenaltyForm" class="space-y-4">
            <input type="hidden" id="editPenaltyId" name="penalty_id">
            
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg mb-4">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    <span class="font-semibold">–ê–≤—Ç–æ—Ä:</span> <span id="editPenaltyAuthor"></span>
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    <span class="font-semibold">–¢–∏–ø:</span> <span id="editPenaltyType"></span>
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–°—É–º–º–∞ *</label>
                    <input type="number" name="amount" id="editPenaltyAmount" step="0.01" min="0" required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ *</label>
                    <select name="applied_to" id="editPenaltyAppliedTo" required
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="one_time">–†–∞–∑–æ–≤—ã–π</option>
                        <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π</option>
                        <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–∏—á–∏–Ω–∞ *</label>
                    <textarea name="reason" id="editPenaltyReason" required rows="3"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                </div>
            </div>
            
            <div class="flex justify-between gap-4 mt-6">
                <button type="button" onclick="deletePenalty()" id="deletePenaltyBtn"
                        class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModals()"
                            class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit"
                            class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
let currentRoles = [];
let currentPenalties = [];
let currentAuthors = [];

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadRoles();
    loadAuthors();
});

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
async function loadRoles() {
    try {
        const response = await fetch('/donations/api/roles/');
        const data = await response.json();
        
        if (data.success) {
            currentRoles = data.roles;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π:', error);
    }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–æ–ª–∏
function openRoleModal(roleId) {
    const role = currentRoles.find(r => r.id === roleId);
    if (!role) return;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('roleId').value = role.id;
    document.getElementById('roleName').value = role.name;
    document.getElementById('roleLevel').value = role.level;
    document.getElementById('roleBonusPercentage').value = role.bonus_percentage;
    document.getElementById('rolePointValue').value = role.point_value;
    document.getElementById('roleColor').value = role.color;
    document.getElementById('roleDescription').value = role.description || '';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É–ª—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (role.formula) {
        document.getElementById('articlesWeight').value = role.formula.articles_weight;
        document.getElementById('likesWeight').value = role.formula.likes_weight;
        document.getElementById('commentsWeight').value = role.formula.comments_weight;
        document.getElementById('viewsWeight').value = role.formula.views_weight;
        document.getElementById('tasksWeight').value = role.formula.tasks_weight;
        document.getElementById('minPointsRequired').value = role.formula.min_points_required;
        document.getElementById('minArticlesRequired').value = role.formula.min_articles_required;
    } else {
        // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('articlesWeight').value = 10.0;
        document.getElementById('likesWeight').value = 0.5;
        document.getElementById('commentsWeight').value = 1.0;
        document.getElementById('viewsWeight').value = 0.01;
        document.getElementById('tasksWeight').value = 5.0;
        document.getElementById('minPointsRequired').value = 0;
        document.getElementById('minArticlesRequired').value = 0;
    }
    
    document.getElementById('roleModalTitle').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏: ${role.name}`;
    document.getElementById('roleModal').classList.remove('hidden');
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–∏
function openCreateRoleModal() {
    document.getElementById('createRoleModal').classList.remove('hidden');
}

// –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
function closeModals(event) {
    if (!event || event.target.classList.contains('hidden') || event.currentTarget === event.target) {
        document.getElementById('roleModal').classList.add('hidden');
        document.getElementById('createRoleModal').classList.add('hidden');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–∏
document.getElementById('roleForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const roleId = document.getElementById('roleId').value;
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å
        const roleResponse = await fetch(`/donations/api/role/${roleId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        const roleResult = await roleResponse.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É–ª—É
        const formulaResponse = await fetch(`/donations/api/formula/${roleId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        const formulaResult = await formulaResponse.json();
        
        if (roleResult.success && formulaResult.success) {
            alert('‚úÖ –†–æ–ª—å –∏ —Ñ–æ—Ä–º—É–ª–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (roleResult.error || formulaResult.error));
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏');
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–∏
document.getElementById('createRoleForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/donations/api/role/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ ' + result.message);
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–∏');
    }
});

// –£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å
async function deleteRole() {
    const roleId = document.getElementById('roleId').value;
    const roleName = document.getElementById('roleName').value;
    
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å "${roleName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/donations/api/role/${roleId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ ' + result.message);
            location.reload();
        } else {
            alert('‚ùå ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showAuthorDetails(authorId) {
    // –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
    window.open(`/admin/donations/authorstats/?author__id__exact=${authorId}`, '_blank');
}

function generateWeeklyReport() {
    if (confirm('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç –∑–∞ –ø—Ä–æ—à–ª—É—é –Ω–µ–¥–µ–ª—é?')) {
        window.location.href = '/admin/donations/weeklyreport/';
    }
}

// ================== –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –ë–û–ù–£–°–û–í ==================

let currentCalcRole = null;

// –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–æ–ª–∏
function updateBonusCalculator() {
    const select = document.getElementById('bonus-calc-role');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption.value) {
        currentCalcRole = null;
        document.getElementById('bonus-formula-display').classList.add('hidden');
        document.getElementById('bonus-result').textContent = '0‚ÇΩ';
        return;
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–ª–∏ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
    currentCalcRole = {
        id: selectedOption.value,
        name: selectedOption.textContent,
        point_value: parseFloat(selectedOption.dataset.pointValue),
        articles_weight: parseFloat(selectedOption.dataset.articlesWeight),
        likes_weight: parseFloat(selectedOption.dataset.likesWeight),
        comments_weight: parseFloat(selectedOption.dataset.commentsWeight),
        views_weight: parseFloat(selectedOption.dataset.viewsWeight),
        tasks_weight: parseFloat(selectedOption.dataset.tasksWeight)
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã
    document.getElementById('formula-articles').textContent = currentCalcRole.articles_weight;
    document.getElementById('formula-views').textContent = currentCalcRole.views_weight;
    document.getElementById('formula-likes').textContent = currentCalcRole.likes_weight;
    document.getElementById('formula-comments').textContent = currentCalcRole.comments_weight;
    document.getElementById('formula-tasks').textContent = currentCalcRole.tasks_weight;
    document.getElementById('bonus-formula-display').classList.remove('hidden');
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –±–æ–Ω—É—Å
    calculateBonus();
}

// –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–æ–Ω—É—Å
function calculateBonus() {
    if (!currentCalcRole) {
        document.getElementById('bonus-result').textContent = '0‚ÇΩ';
        document.getElementById('bonus-detail-articles').textContent = '0 –±–∞–ª–ª–æ–≤';
        document.getElementById('bonus-detail-views').textContent = '0 –±–∞–ª–ª–æ–≤';
        document.getElementById('bonus-detail-likes').textContent = '0 –±–∞–ª–ª–æ–≤';
        document.getElementById('bonus-detail-comments').textContent = '0 –±–∞–ª–ª–æ–≤';
        document.getElementById('bonus-detail-tasks').textContent = '0 –±–∞–ª–ª–æ–≤';
        document.getElementById('bonus-detail-total').textContent = '0';
        document.getElementById('bonus-detail-rate').textContent = '0‚ÇΩ';
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π
    const articles = parseInt(document.getElementById('bonus-calc-articles').value) || 0;
    const views = parseInt(document.getElementById('bonus-calc-views').value) || 0;
    const likes = parseInt(document.getElementById('bonus-calc-likes').value) || 0;
    const comments = parseInt(document.getElementById('bonus-calc-comments').value) || 0;
    const tasks = parseInt(document.getElementById('bonus-calc-tasks').value) || 0;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–ª–ª—ã –ø–æ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const pointsArticles = articles * currentCalcRole.articles_weight;
    const pointsViews = views * currentCalcRole.views_weight;
    const pointsLikes = likes * currentCalcRole.likes_weight;
    const pointsComments = comments * currentCalcRole.comments_weight;
    const pointsTasks = tasks * currentCalcRole.tasks_weight;
    
    const totalPoints = pointsArticles + pointsViews + pointsLikes + pointsComments + pointsTasks;
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –±–∞–ª–ª–æ–≤ –≤ —Ä—É–±–ª–∏
    const earnings = Math.round(totalPoints * currentCalcRole.point_value);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    document.getElementById('bonus-result').textContent = earnings.toLocaleString('ru-RU') + '‚ÇΩ';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é
    document.getElementById('bonus-detail-articles').textContent = Math.round(pointsArticles).toLocaleString('ru-RU') + ' –±–∞–ª–ª–æ–≤';
    document.getElementById('bonus-detail-views').textContent = Math.round(pointsViews).toLocaleString('ru-RU') + ' –±–∞–ª–ª–æ–≤';
    document.getElementById('bonus-detail-likes').textContent = Math.round(pointsLikes).toLocaleString('ru-RU') + ' –±–∞–ª–ª–æ–≤';
    document.getElementById('bonus-detail-comments').textContent = Math.round(pointsComments).toLocaleString('ru-RU') + ' –±–∞–ª–ª–æ–≤';
    document.getElementById('bonus-detail-tasks').textContent = Math.round(pointsTasks).toLocaleString('ru-RU') + ' –±–∞–ª–ª–æ–≤';
    document.getElementById('bonus-detail-total').textContent = Math.round(totalPoints).toLocaleString('ru-RU');
    document.getElementById('bonus-detail-rate').textContent = currentCalcRole.point_value + '‚ÇΩ';
}

// ================== –®–¢–†–ê–§–´/–ü–†–ï–ú–ò–ò ==================

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤ (–ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
async function loadAuthors() {
    try {
        const response = await fetch('/donations/api/authors/');
        const data = await response.json();
        
        if (data.success && data.authors) {
            currentAuthors = data.authors;
            console.log(`üìã –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≤—Ç–æ—Ä–æ–≤: ${data.authors.length}`);
            
            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å select –∑–∞—Ä–∞–Ω–µ–µ
            const select = document.getElementById('penaltyAuthorSelect');
            if (select) {
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞...</option>';
                
                data.authors.forEach(author => {
                    const option = document.createElement('option');
                    option.value = author.id;
                    option.textContent = `${author.full_name} (@${author.username})`;
                    select.appendChild(option);
                });
            }
        } else {
            console.warn('‚ö†Ô∏è API –∞–≤—Ç–æ—Ä–æ–≤ –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤:', error);
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —à—Ç—Ä–∞—Ñ–æ–≤/–ø—Ä–µ–º–∏–π
async function loadPenalties() {
    try {
        const response = await fetch('/donations/api/penalties/');
        const data = await response.json();
        
        if (data.success) {
            currentPenalties = data.penalties;
            renderPenalties(data.penalties);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ç—Ä–∞—Ñ–æ–≤/–ø—Ä–µ–º–∏–π:', error);
    }
}

// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —à—Ç—Ä–∞—Ñ—ã/–ø—Ä–µ–º–∏–∏
function renderPenalties(penalties) {
    const widget = document.getElementById('penaltiesWidget');
    
    if (penalties.length === 0) {
        widget.innerHTML = `
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —à—Ç—Ä–∞—Ñ–æ–≤ –∏–ª–∏ –ø—Ä–µ–º–∏–π
            </div>
        `;
        return;
    }
    
    widget.innerHTML = penalties.map(penalty => {
        const isPenalty = penalty.type === 'penalty';
        const bgColor = isPenalty ? 'bg-red-50 dark:bg-red-900/20' : 'bg-green-50 dark:bg-green-900/20';
        const borderColor = isPenalty ? 'border-red-200 dark:border-red-800' : 'border-green-200 dark:border-green-800';
        const textColor = isPenalty ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';
        const icon = isPenalty ? '‚ö†Ô∏è' : 'üéÅ';
        
        const amountText = penalty.amount_type === 'percentage' 
            ? `${penalty.amount}%` 
            : `${penalty.amount}‚ÇΩ`;
        
        return `
            <div class="p-4 ${bgColor} border ${borderColor} rounded-lg cursor-pointer hover:shadow-md transition-shadow"
                 onclick="openEditPenaltyModal(${penalty.id})">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">${icon}</span>
                            <h4 class="font-bold ${textColor}">${penalty.type_display}</h4>
                            <span class="text-lg font-bold ${textColor}">${amountText}</span>
                        </div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
                            <span class="font-semibold">–ê–≤—Ç–æ—Ä:</span> ${penalty.author.full_name}
                        </p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                            <span class="font-semibold">–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:</span> ${penalty.applied_to_display}
                        </p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            ${penalty.reason}
                        </p>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        ${new Date(penalty.created_at).toLocaleDateString('ru-RU')}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω
function togglePenaltiesAccordion() {
    const content = document.getElementById('penaltiesAccordionContent');
    const icon = document.getElementById('penaltiesAccordionIcon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —à—Ç—Ä–∞—Ñ—ã/–ø—Ä–µ–º–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        loadPenalties();
    } else {
        content.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞/–ø—Ä–µ–º–∏–∏
async function openCreatePenaltyModal() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Å–µ–ª–µ–∫—Ç–µ
    const select = document.getElementById('penaltyAuthorSelect');
    select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ—Ä–æ–≤...</option>';
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('createPenaltyModal').classList.remove('hidden');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤—Ç–æ—Ä–æ–≤ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º)
    try {
        const response = await fetch('/donations/api/authors/');
        const data = await response.json();
        
        if (data.success && data.authors) {
            currentAuthors = data.authors;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º select
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞...</option>';
            
            data.authors.forEach(author => {
                const option = document.createElement('option');
                option.value = author.id;
                option.textContent = `${author.full_name} (@${author.username})`;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≤—Ç–æ—Ä–æ–≤: ${data.authors.length}`);
        } else {
            select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤</option>';
            console.error('–û—à–∏–±–∫–∞: API –Ω–µ –≤–µ—Ä–Ω—É–ª –∞–≤—Ç–æ—Ä–æ–≤');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤:', error);
        select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤</option>';
    }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function openEditPenaltyModal(penaltyId) {
    const penalty = currentPenalties.find(p => p.id === penaltyId);
    if (!penalty) return;
    
    document.getElementById('editPenaltyId').value = penalty.id;
    document.getElementById('editPenaltyAuthor').textContent = penalty.author.full_name;
    document.getElementById('editPenaltyType').textContent = penalty.type_display;
    document.getElementById('editPenaltyAmount').value = penalty.amount;
    document.getElementById('editPenaltyAppliedTo').value = penalty.applied_to;
    document.getElementById('editPenaltyReason').value = penalty.reason;
    
    document.getElementById('editPenaltyTitle').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ${penalty.type_display}`;
    document.getElementById('editPenaltyModal').classList.remove('hidden');
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —à—Ç—Ä–∞—Ñ–æ–≤)
function closeModals(event) {
    if (!event || event.target.classList.contains('hidden') || event.currentTarget === event.target) {
        document.getElementById('roleModal')?.classList.add('hidden');
        document.getElementById('createRoleModal')?.classList.add('hidden');
        document.getElementById('createPenaltyModal')?.classList.add('hidden');
        document.getElementById('editPenaltyModal')?.classList.add('hidden');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞/–ø—Ä–µ–º–∏–∏
document.getElementById('createPenaltyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/donations/api/penalty/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ ' + result.message);
            closeModals();
            loadPenalties();
            e.target.reset();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞/–ø—Ä–µ–º–∏–∏
document.getElementById('editPenaltyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const penaltyId = document.getElementById('editPenaltyId').value;
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch(`/donations/api/penalty/${penaltyId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ ' + result.message);
            closeModals();
            loadPenalties();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
    }
});

// –£–¥–∞–ª–∏—Ç—å —à—Ç—Ä–∞—Ñ/–ø—Ä–µ–º–∏—é
async function deletePenalty() {
    const penaltyId = document.getElementById('editPenaltyId').value;
    
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
        return;
    }
    
    try {
        const response = await fetch(`/donations/api/penalty/${penaltyId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ ' + result.message);
            closeModals();
            loadPenalties();
        } else {
            alert('‚ùå ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
}
</script>

{% endblock %}

