{% extends 'donations/base.html' %}
{% load static %}

{% block title %}QR-код для оплаты{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    
    <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
        <div class="mb-6">
            <i class="fas fa-qrcode text-purple-600 text-5xl"></i>
        </div>
        
        <h1 class="text-3xl font-bold text-gray-900 mb-4">
            Отсканируйте QR-код для оплаты
        </h1>
        
        <p class="text-gray-600 mb-6">
            Используйте камеру вашего телефона или банковское приложение
        </p>
        
        <!-- QR-код -->
        {% if donation.qr_code %}
        <div class="flex justify-center mb-6">
            <div class="border-4 border-purple-200 rounded-2xl p-4">
                <img src="{{ donation.qr_code }}" alt="QR-код для оплаты" class="max-w-md w-full">
            </div>
        </div>
        {% endif %}
        
        <!-- Информация о платеже -->
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
            <div class="grid grid-cols-2 gap-4 text-left">
                <div>
                    <p class="text-sm text-gray-600">Сумма:</p>
                    <p class="text-xl font-bold text-gray-900">{{ donation.amount }} ₽</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Статус:</p>
                    <p class="text-xl font-bold text-orange-600">
                        <i class="fas fa-clock"></i> {{ donation.get_status_display }}
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Альтернативная ссылка -->
        {% if donation.payment_url %}
        <div class="mb-6">
            <p class="text-sm text-gray-600 mb-2">Или перейдите по ссылке:</p>
            <a href="{{ donation.payment_url }}" 
               target="_blank"
               class="inline-block bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition">
                <i class="fas fa-external-link-alt mr-2"></i>
                Открыть страницу оплаты
            </a>
        </div>
        {% endif %}
        
        <!-- Проверка статуса -->
        <div class="text-center">
            <button onclick="checkPaymentStatus()" 
                    class="text-purple-600 hover:text-purple-700 font-semibold">
                <i class="fas fa-sync-alt mr-2"></i>
                Проверить статус оплаты
            </button>
        </div>
    </div>
    
    <!-- Инструкция -->
    <div class="mt-8 bg-blue-50 rounded-lg p-6">
        <h3 class="font-bold text-gray-900 mb-3">
            <i class="fas fa-info-circle text-blue-600"></i> Как оплатить:
        </h3>
        <ol class="list-decimal list-inside space-y-2 text-gray-700">
            <li>Откройте камеру или банковское приложение на телефоне</li>
            <li>Наведите на QR-код</li>
            <li>Подтвердите платеж</li>
            <li>Дождитесь подтверждения</li>
        </ol>
    </div>
</div>

<script>
function checkPaymentStatus() {
    fetch("{% url 'donations:check_payment_status' donation.id %}")
        .then(response => response.json())
        .then(data => {
            if (data.status === 'succeeded') {
                window.location.href = "{% url 'donations:donation_status' donation.id %}";
            } else {
                alert('Статус платежа: ' + data.status);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Не удалось проверить статус');
        });
}

// Автоматическая проверка статуса каждые 10 секунд
setInterval(checkPaymentStatus, 10000);
</script>
{% endblock %}
