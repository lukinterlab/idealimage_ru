{% extends 'base_tailwind.html' %}
{% load static %}

{% block title %}–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–∞–π–ø–ª–∞–π–Ω–æ–≤{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-4xl md:text-5xl font-black text-white flex items-center gap-3">
                        <span>üß©</span>
                        –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
                    </h1>
                    <p class="text-lg text-gray-300 mt-2 max-w-3xl">
                        –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –º–æ–¥–µ—Ä–∞—Ü–∏–∏, SEO, Telegram, —Ä–µ–∫–ª–∞–º—ã –∏ –±–æ–Ω—É—Å–æ–≤. –ü–∞–π–ø–ª–∞–π–Ω—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —à–∞–≥–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è –≤ –µ–¥–∏–Ω—É—é —Ü–µ–ø–æ—á–∫—É.
                    </p>
                </div>
                <a href="{% url 'asistent:admin_dashboard' %}"
                   class="px-4 py-2 rounded-lg font-semibold border border-white/30 text-white/90 hover:bg-white/10 transition-colors flex items-center gap-2">
                    <span>‚Ü©Ô∏è</span>
                    –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É
                </a>
            </div>
        </div>

        {% verbatim %}
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6" id="pipeline-builder-app" v-cloak>
            <div class="lg:col-span-1 bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-5 space-y-4 relative z-20">
                <div class="flex items-center justify-between flex-wrap gap-3 relative z-20">
                    <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                        <span>üìö</span> –ü–∞–π–ø–ª–∞–π–Ω—ã
                    </h2>
                    <div class="flex items-center gap-2 flex-wrap relative z-20">
                        <div class="flex items-center gap-2 bg-white/90 text-gray-800 dark:bg-black/30 dark:text-gray-200 border border-white/40 dark:border-white/10 rounded-lg px-2 py-1 transition-colors relative z-30 shadow-lg">
                            <select v-model="selectedPreset"
                                    class="bg-transparent text-sm text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 rounded-md px-1 py-0.5 relative z-30">
                                <option value="">–°–æ–∑–¥–∞—Ç—å –∏–∑ –ø—Ä–µ—Å–µ—Ç–∞‚Ä¶</option>
                                <option v-for="preset in presets" :key="preset.slug" :value="preset.slug">
                                    {{ preset.name }}
                                </option>
                            </select>
                            <button type="button"
                                    @click="createPipelineFromPreset"
                                    :disabled="!selectedPreset"
                                    class="px-2 py-1 rounded-md text-xs font-semibold bg-emerald-500/20 border border-emerald-500/40 text-emerald-100 hover:bg-emerald-500/30 disabled:opacity-40 disabled:cursor-not-allowed"
                                    title="–°–æ–∑–¥–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞">
                                –°–æ–∑–¥–∞—Ç—å
                            </button>
                        </div>
                        <button type="button" @click="createPipeline"
                                class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-purple-600 hover:bg-purple-700 text-white transition-colors"
                                title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω —Å –Ω—É–ª—è">
                            –ù–æ–≤—ã–π
                        </button>
                    </div>
                </div>
                <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-1">
                    <button v-for="pipeline in pipelines"
                            :key="pipeline.id"
                            @click="selectPipeline(pipeline.id)"
                            class="w-full text-left px-3 py-2 rounded-xl border transition"
                            :class="selectedId === pipeline.id
                                ? 'bg-purple-600/30 border-purple-500/60 text-white'
                                : 'bg-white/5 border-white/10 text-gray-200 hover:bg-white/10'">
                        <div class="flex items-center justify-between gap-2">
                            <span class="font-semibold text-sm">{{ pipeline.name }}</span>
                            <span class="text-xs px-2 py-0.5 rounded-full border border-white/20 text-white/70">{{ pipeline.kind }}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 line-clamp-2">{{ pipeline.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>
                    </button>
                    <p v-if="pipelines.length === 0" class="text-sm text-gray-400">
                        –ü–∞–π–ø–ª–∞–π–Ω—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã. –ù–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤—ã–π¬ª, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π.
                    </p>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6" v-if="current">
                <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 space-y-4">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <h2 class="text-2xl font-semibold text-white flex items-center gap-2">
                            <span>‚öôÔ∏è</span> –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </h2>
                        <div class="flex items-center gap-3 flex-wrap">
                            <button type="button" @click="deletePipeline"
                                    class="px-4 py-2 rounded-lg text-sm font-semibold bg-rose-500/30 hover:bg-rose-500/40 border border-rose-400/40 text-rose-200 transition"
                                    title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–∞–π–ø–ª–∞–π–Ω">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                            <button type="button" @click="openRunModal"
                                    class="px-4 py-2 rounded-lg text-sm font-semibold bg-blue-500/30 hover:bg-blue-500/40 border border-blue-400/40 text-blue-100 transition"
                                    title="–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç">
                                –ó–∞–ø—É—Å—Ç–∏—Ç—å
                            </button>
                            <button type="button" @click="savePipeline"
                                    class="px-4 py-2 rounded-lg text-sm font-semibold bg-emerald-500 hover:bg-emerald-600 text-white transition"
                                    title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="space-y-2">
                            <span class="text-sm text-gray-300">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                            <input type="text" v-model="current.name"
                                   class="w-full px-4 py-2 rounded-lg bg-black/40 border border-white/20 text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        </label>
                        <div class="space-y-2">
                            <span class="text-sm text-gray-300">–°–∏—Å—Ç–µ–º–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</span>
                            <div class="px-4 py-2 rounded-lg bg-black/30 border border-white/10 text-xs text-gray-300 font-mono">
                                {{ current.slug || '–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏' }}
                            </div>
                        </div>
                        <label class="space-y-2">
                            <span class="text-sm text-gray-300">–¢–∏–ø</span>
                            <select v-model="current.kind"
                                    class="w-full px-4 py-2 rounded-lg bg-black/40 border border-white/20 text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <option value="article">–°—Ç–∞—Ç—å–∏</option>
                                <option value="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</option>
                                <option value="seo">SEO</option>
                                <option value="distribution">–î–∏—Å—Ç—Ä–∏–±—É—Ü–∏—è</option>
                                <option value="advertising">–†–µ–∫–ª–∞–º–∞</option>
                                <option value="donations">–î–æ–Ω–∞—Ç—ã</option>
                                <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π</option>
                            </select>
                        </label>
                        <label class="flex items-center gap-3 text-sm text-gray-200 mt-6 md:mt-0">
                            <input type="checkbox" v-model="current.is_active"
                                   class="w-5 h-5 rounded border-white/30 bg-black/40">
                            –ê–∫—Ç–∏–≤–µ–Ω
                        </label>
                    </div>

                    <label class="space-y-2 block">
                        <span class="text-sm text-gray-300">–û–ø–∏—Å–∞–Ω–∏–µ</span>
                        <textarea v-model="current.description" rows="3"
                                  class="w-full px-4 py-3 rounded-lg bg-black/40 border border-white/20 text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                    </label>
                </div>

                <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-semibold text-white flex items-center gap-2">
                            <span>‚è±Ô∏è</span> –¢—Ä–∏–≥–≥–µ—Ä—ã
                        </h2>
                        <div class="relative">
                            <select v-model="selectedTrigger"
                                    class="px-4 py-2 rounded-lg bg-black/50 border border-white/20 text-white">
                                <option disabled value="">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä...</option>
                                <option v-for="trigger in catalog.triggers" :key="trigger.code" :value="trigger.code">
                                    {{ trigger.name }} ({{ trigger.category }})
                                </option>
                            </select>
                            <button v-if="selectedTrigger"
                                    @click="addTrigger"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 text-emerald-300 hover:text-emerald-100">
                                ‚ûï
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3" ref="triggersSortable">
                        <div v-for="(trigger, index) in current.triggers" :key="`${trigger.code}-${index}`"
                             class="border border-white/10 rounded-xl p-4 bg-black/30 space-y-3">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex items-center gap-2">
                                    <span class="drag-handle text-gray-400 hover:text-gray-200 cursor-move select-none" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ">
                                        ::
                                    </span>
                                    <div>
                                    <p class="text-white font-semibold text-sm">{{ trigger.code }}</p>
                                    <p class="text-xs text-gray-300">{{ triggerTitle(trigger.code) }}</p>
                                    </div>
                                </div>
                                <button @click="removeTrigger(index)"
                                        class="text-sm text-rose-300 hover:text-rose-100">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                            <label class="block text-xs text-gray-300 space-y-2">
                                –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (JSON)
                                <textarea v-model="trigger.parameters_json"
                                          @change="syncTriggerParameters(trigger)"
                                          class="w-full px-3 py-2 rounded-lg bg-black/50 border border-white/20 text-gray-100 font-mono text-xs"
                                          rows="3"></textarea>
                            </label>
                            <label class="block text-xs text-gray-300 space-y-2">
                                –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                                <textarea v-model="trigger.instruction"
                                          class="w-full px-3 py-2 rounded-lg bg-black/40 border border-white/20 text-gray-100 text-xs"
                                          rows="2"
                                          placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç —ç—Ç–æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä –∏ –∫–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–±–ª—é–¥–∞—Ç—å—Å—è."></textarea>
                            </label>
                        </div>
                        <p v-if="current.triggers.length === 0" class="text-sm text-gray-400">
                            –ù–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤. –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—É—Å–∫–∞.
                        </p>
                    </div>
                </div>

                <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-semibold text-white flex items-center gap-2">
                            <span>ü™ú</span> –®–∞–≥–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞
                        </h2>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div class="relative">
                                <select v-model="selectedStep"
                                        class="px-4 py-2 rounded-lg bg-black/50 border border-white/20 text-white">
                                    <option disabled value="">–î–æ–±–∞–≤–∏—Ç—å —à–∞–≥...</option>
                                    <option v-for="step in catalog.steps" :key="step.code" :value="step.code">
                                        {{ step.name }} ({{ step.category }})
                                    </option>
                                </select>
                                <button v-if="selectedStep"
                                        @click="addStep"
                                        class="absolute right-2 top-1/2 -translate-y-1/2 text-emerald-300 hover:text-emerald-100">
                                    ‚ûï
                                </button>
                            </div>
                            <div class="relative">
                                <select v-model="selectedPrompt"
                                        class="px-4 py-2 rounded-lg bg-black/50 border border-white/20 text-white">
                                    <option disabled value="">–î–æ–±–∞–≤–∏—Ç—å —à–∞–≥ –∏–∑ –ø—Ä–æ–º—Ç–∞...</option>
                                    <option v-for="prompt in promptTemplates" :key="prompt.id" :value="prompt.name">
                                        {{ prompt.name }} ({{ prompt.category_display || prompt.category || 'prompt' }})
                                    </option>
                                </select>
                                <button v-if="selectedPrompt"
                                        @click="addPromptStep"
                                        class="absolute right-2 top-1/2 -translate-y-1/2 text-emerald-300 hover:text-emerald-100">
                                    ‚ûï
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3" ref="stepsSortable">
                        <div v-for="(step, index) in current.steps" :key="`${step.code}-${index}`"
                             class="border border-white/10 rounded-xl p-4 bg-black/30 space-y-3">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex items-center gap-2">
                                    <span class="drag-handle text-gray-400 hover:text-gray-200 cursor-move select-none" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ">
                                        ::
                                    </span>
                                    <div>
                                        <p class="text-white font-semibold text-sm">{{ step.code }}</p>
                                        <p class="text-xs text-gray-300">{{ stepTitle(step.code) }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 text-xs text-gray-300">
                                    <label class="flex items-center gap-2">
                                        <span>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
                                        <input type="number" v-model.number="step.priority"
                                               class="w-16 px-2 py-1 rounded bg-black/60 border border-white/20 text-gray-100">
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" v-model="step.enabled"
                                               class="w-4 h-4 rounded border-white/30 bg-black/40">
                                        –ê–∫—Ç–∏–≤–µ–Ω
                                    </label>
                                    <button @click="removeStep(index)"
                                            class="text-rose-300 hover:text-rose-100 text-sm">
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            <label class="block text-xs text-gray-300 space-y-2">
                                –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (JSON)
                                <textarea v-model="step.parameters_json"
                                          @change="syncStepParameters(step)"
                                          class="w-full px-3 py-2 rounded-lg bg-black/50 border border-white/20 text-gray-100 font-mono text-xs"
                                          rows="4"></textarea>
                            </label>
                            <label class="block text-xs text-gray-300 space-y-2">
                                –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —à–∞–≥–∞
                                <textarea v-model="step.instruction"
                                          class="w-full px-3 py-2 rounded-lg bg-black/40 border border-white/20 text-gray-100 text-xs"
                                          rows="3"
                                          placeholder="–û–ø–∏—à–∏—Ç–µ, –∑–∞—á–µ–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —à–∞–≥ –∏ —á—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è/–∏–∑–º–µ–Ω—è–µ—Ç—Å—è."></textarea>
                            </label>
                        </div>
                        <p v-if="current.steps.length === 0" class="text-sm text-gray-400">
                            –î–æ–±–∞–≤—å—Ç–µ —à–∞–≥–∞, —á—Ç–æ–±—ã –ø–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω—è–ª –¥–µ–π—Å—Ç–≤–∏—è.
                        </p>
                    </div>
                </div>

                <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-semibold text-white flex items-center gap-2">
                            <span>üì¨</span> –î–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ —à–∞–≥–∞
                        </h2>
                        <div class="relative">
                            <select v-model="selectedAction"
                                    class="px-4 py-2 rounded-lg bg-black/50 border border-white/20 text-white">
                                <option disabled value="">–î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ...</option>
                                <option v-for="action in catalog.actions" :key="action.code" :value="action.code">
                                    {{ action.name }} ({{ action.category }})
                                </option>
                            </select>
                            <button v-if="selectedAction"
                                    @click="addAction"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 text-emerald-300 hover:text-emerald-100">
                                ‚ûï
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3" ref="actionsSortable">
                        <div v-for="(action, index) in current.actions" :key="`${action.code}-${index}`"
                             class="border border-white/10 rounded-xl p-4 bg-black/30 space-y-3">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex items-center gap-2">
                                    <span class="drag-handle text-gray-400 hover:text-gray-200 cursor-move select-none" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ">
                                        ::
                                    </span>
                                    <div>
                                        <p class="text-white font-semibold text-sm">{{ action.code }}</p>
                                        <p class="text-xs text-gray-300">{{ actionTitle(action.code) }}</p>
                                    </div>
                                </div>
                                <button @click="removeAction(index)"
                                        class="text-sm text-rose-300 hover:text-rose-100">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                            <label class="block text-xs text-gray-300 space-y-2">
                                –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (JSON)
                                <textarea v-model="action.parameters_json"
                                          @change="syncActionParameters(action)"
                                          class="w-full px-3 py-2 rounded-lg bg-black/50 border border-white/20 text-gray-100 font-mono text-xs"
                                          rows="3"></textarea>
                            </label>
                            <label class="block text-xs text-gray-300 space-y-2">
                                –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—è
                                <textarea v-model="action.instruction"
                                          class="w-full px-3 py-2 rounded-lg bg-black/40 border border-white/20 text-gray-100 text-xs"
                                          rows="2"
                                          placeholder="–£—Ç–æ—á–Ω–∏—Ç–µ, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞."></textarea>
                            </label>
                        </div>
                        <p v-if="current.actions.length === 0" class="text-sm text-gray-400">
                            –î–æ–±–∞–≤—å—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è, —á—Ç–æ–±—ã –æ–ø–æ–≤–µ—â–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –∞–≤—Ç–æ—Ä–æ–≤ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞.
                        </p>
                    </div>
                </div>

                <div v-if="toast"
                     :class="toast.success ? 'bg-emerald-500/20 border-emerald-400/50 text-emerald-200' : 'bg-rose-500/20 border-rose-400/50 text-rose-200'"
                     class="rounded-xl px-4 py-3 border transition">
                    {{ toast.message }}
                </div>
                <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-semibold text-white flex items-center gap-2">
                            <span>üßæ</span> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤
                        </h2>
                        <span class="text-sm text-gray-300">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5</span>
                    </div>
                    <div v-if="runHistory.length === 0" class="text-sm text-gray-400">
                        –ó–∞–ø—É—Å–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ.
                    </div>
                    <div v-else class="space-y-3">
                        <div v-for="run in runHistory" :key="run.id"
                             class="border border-white/10 rounded-xl p-4 bg-black/30 text-sm text-gray-200">
                            <div class="flex items-center justify-between gap-3">
                                <div>
                                    <span class="font-semibold" :class="run.statusClass">{{ run.statusDisplay }}</span>
                                    <span class="text-xs text-gray-400 ml-2">{{ run.started_at }}</span>
                                </div>
                                <button type="button" @click="repeatRun(run)"
                                        class="px-3 py-1 rounded-lg text-xs font-semibold bg-white/10 hover:bg-white/20 border border-white/20">
                                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                                </button>
                            </div>
                            <div class="mt-2 text-xs text-gray-300">
                                Payload:
                                <code class="font-mono bg-black/40 px-2 py-1 rounded">{{ run.payloadPreview }}</code>
                            </div>
                            <div v-if="run.error_message" class="mt-2 text-xs text-rose-300">
                                –û—à–∏–±–∫–∞: {{ run.error_message }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="showRunModal" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6">
                <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" @click="closeRunModal"></div>
                <div class="relative z-10 w-full max-w-lg bg-gray-900/95 dark:bg-gray-900/95 border border-white/20 rounded-2xl shadow-2xl p-6 space-y-5">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-white">–ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞</h3>
                        <button type="button"
                                class="text-gray-400 hover:text-gray-200 transition"
                                @click="closeRunModal">
                            ‚úï
                        </button>
                    </div>
                    <p class="text-sm text-gray-300">
                        –í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ payload. JSON-–∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–æ —Å —Ü–µ–ª—å—é –∑–∞–ø—É—Å–∫–∞.
                    </p>
                    <div class="space-y-4">
                        <label class="block text-sm text-gray-200 space-y-2">
                            <span>–ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞<span class="text-rose-300">*</span></span>
                            <select v-model="runModal.zodiacSign"
                                    class="w-full px-4 py-2 rounded-lg bg-black/50 border border-white/20 text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <option disabled value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞–∫‚Ä¶</option>
                                <option v-for="sign in zodiacSigns" :key="sign" :value="sign">
                                    {{ sign }}
                                </option>
                            </select>
                        </label>
                        <label class="block text-sm text-gray-200 space-y-2">
                            <span>Payload (JSON, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                            <textarea ref="runPayloadInput"
                                      v-model="runModal.payloadText"
                                      rows="5"
                                      class="w-full px-4 py-3 rounded-lg bg-black/50 border border-white/20 text-gray-100 font-mono text-xs focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                      placeholder='{"extra": "–∑–Ω–∞—á–µ–Ω–∏–µ"}'></textarea>
                        </label>
                        <p v-if="runModal.error" class="text-sm text-rose-300">
                            {{ runModal.error }}
                        </p>
                    </div>
                    <div class="flex items-center justify-end gap-3">
                        <button type="button"
                                class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-gray-200 hover:bg-white/20 transition"
                                @click="closeRunModal">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="button"
                                class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition"
                                @click="confirmRunModal">
                            –ó–∞–ø—É—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <div v-else class="lg:col-span-3 bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-10 text-center text-gray-200">
                <div class="text-6xl mb-4">üõ†Ô∏è</div>
                <p class="text-lg">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–π–ø–ª–∞–π–Ω —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π, —á—Ç–æ–±—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ.</p>
            </div>
        </div>
        {% endverbatim %}
    </div>
</div>

<form method="post" id="pipeline-csrf">{% csrf_token %}</form>
<script>
    window.CSRF_TOKEN = document.querySelector('#pipeline-csrf input[name=csrfmiddlewaretoken]').value;
    window.PIPELINE_CATALOG = JSON.parse('{{ catalog_json|escapejs }}');
    window.PIPELINE_PRESETS = JSON.parse('{{ presets_json|escapejs }}');
    window.PIPELINE_PROMPTS = JSON.parse('{{ prompt_templates_json|escapejs }}');
    window.PIPELINES_INITIAL = JSON.parse('{{ pipelines_json|escapejs }}');
    window.PIPELINE_ENDPOINTS = {
        list: "{% url 'asistent:api_pipelines' %}",
        catalog: "{% url 'asistent:api_pipeline_catalog' %}",
        presets: "{% url 'asistent:api_pipeline_presets' %}",
        fromPreset: "{% url 'asistent:api_pipeline_from_preset' %}",
        detail: function(id) { return "{% url 'asistent:api_pipeline_detail' 0 %}".replace('0', id); },
        run: function(id) { return "{% url 'asistent:api_pipeline_run' 0 %}".replace('0', id); }
    };
</script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    (function () {
        const { createApp } = Vue;
        const Sortable = window.Sortable;
        const catalog = window.PIPELINE_CATALOG;
        const presets = window.PIPELINE_PRESETS || [];
        catalog.triggers = (catalog.triggers || []).sort((a, b) => {
            const categoryCompare = (a.category || '').localeCompare(b.category || '', 'ru');
            if (categoryCompare !== 0) return categoryCompare;
            return (a.name || a.code).localeCompare(b.name || b.code, 'ru');
        });
        catalog.steps = (catalog.steps || []).map(step => ({
            ...step,
            name: step.name || step.code,
            description: step.description || '',
            category: step.category || 'misc',
        })).sort((a, b) => {
            if (a.category === b.category) {
                return a.name.localeCompare(b.name, 'ru');
            }
            return a.category.localeCompare(b.category, 'ru');
        });
        const statusDisplayMap = {
            success: "–£—Å–ø–µ—Ö",
            failed: "–û—à–∏–±–∫–∞",
            running: "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è",
            pending: "–û–∂–∏–¥–∞–µ—Ç",
        };

        const statusClassMap = {
            success: "text-emerald-300",
            failed: "text-rose-300",
            running: "text-blue-300",
            pending: "text-gray-300",
        };

        function decorateRuns(rawRuns) {
            return (rawRuns || []).map((run) => {
                const payloadString = JSON.stringify(run.payload || {}, null, 0);
                const preview =
                    payloadString.length > 120
                        ? payloadString.slice(0, 117) + "..."
                        : payloadString;
                return {
                    ...run,
                    statusDisplay: statusDisplayMap[run.status] || run.status,
                    statusClass: statusClassMap[run.status] || "text-gray-300",
                    payloadPreview: preview || "{}",
                };
            });
        }

        const initial = (window.PIPELINES_INITIAL || []).map((pipeline) => ({
            ...pipeline,
            runs: decorateRuns(pipeline.runs || []),
        }));

        function clone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        function prepareItem(item) {
            return {
                ...item,
                instruction: item.instruction || "",
                parameters_json: JSON.stringify(item.parameters || {}, null, 2),
            };
        }

        const firstPipeline = initial.length ? initial[0] : null;

        createApp({
            data() {
                return {
                    catalog,
                    pipelines: initial,
                    presets,
                    promptTemplates: window.PIPELINE_PROMPTS || [],
                    selectedId: firstPipeline ? firstPipeline.id : null,
                    current: null,
                    selectedStep: '',
                    selectedPrompt: '',
                    selectedTrigger: '',
                    selectedAction: '',
                    selectedPreset: '',
                    toast: null,
                    lastPayloadInput: '{"post_id": null}',
                    runHistory: [],
                    sortables: {
                        triggers: null,
                        steps: null,
                        actions: null,
                    },
                    zodiacSigns: [
                        "–û–≤–µ–Ω",
                        "–¢–µ–ª–µ—Ü",
                        "–ë–ª–∏–∑–Ω–µ—Ü—ã",
                        "–†–∞–∫",
                        "–õ–µ–≤",
                        "–î–µ–≤–∞",
                        "–í–µ—Å—ã",
                        "–°–∫–æ—Ä–ø–∏–æ–Ω",
                        "–°—Ç—Ä–µ–ª–µ—Ü",
                        "–ö–æ–∑–µ—Ä–æ–≥",
                        "–í–æ–¥–æ–ª–µ–π",
                        "–†—ã–±—ã",
                    ],
                    showRunModal: false,
                    runModal: {
                        zodiacSign: '',
                        payloadText: '{"post_id": null}',
                        error: '',
                    },
                };
            },
            created() {
                if (firstPipeline) {
                    this.current = this.preparePipeline(firstPipeline);
                    this.runHistory = [...(firstPipeline.runs || [])];
                    this.$nextTick(() => this.setupSortables());
                }
            },
            mounted() {
                if (this.current) {
                    this.$nextTick(() => this.setupSortables());
                }
            },
            beforeUnmount() {
                this.destroySortables();
            },
            watch: {
                selectedId(newId) {
                    if (newId) {
                        this.fetchPipeline(newId);
                    }
                }
            },
            methods: {
                refreshSortables() {
                    this.$nextTick(() => {
                        this.setupSortables();
                    });
                },
                setupSortables() {
                    if (!Sortable) {
                        return;
                    }
                    this.destroySortables();
                    if (!this.current) {
                        return;
                    }
                    this.initSortable('triggersSortable', 'triggers');
                    this.initSortable('stepsSortable', 'steps');
                    this.initSortable('actionsSortable', 'actions');
                },
                destroySortables() {
                    Object.keys(this.sortables).forEach((key) => {
                        const instance = this.sortables[key];
                        if (instance && typeof instance.destroy === 'function') {
                            instance.destroy();
                        }
                        this.sortables[key] = null;
                    });
                },
                initSortable(refName, type) {
                    let container = this.$refs[refName];
                    if (Array.isArray(container)) {
                        container = container[0];
                    }
                    if (!container || !Sortable) {
                        return;
                    }
                    this.sortables[type] = new Sortable(container, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        onEnd: (evt) => {
                            if (evt.oldIndex === evt.newIndex || evt.oldIndex == null || evt.newIndex == null) {
                                return;
                            }
                            this.reorderList(type, evt.oldIndex, evt.newIndex);
                        },
                    });
                },
                reorderList(type, oldIndex, newIndex) {
                    if (!this.current || !Array.isArray(this.current[type])) {
                        return;
                    }
                    const list = this.current[type];
                    if (oldIndex < 0 || newIndex < 0 || oldIndex >= list.length || newIndex >= list.length) {
                        return;
                    }
                    const [moved] = list.splice(oldIndex, 1);
                    list.splice(newIndex, 0, moved);
                    if (type === 'steps') {
                        this.normalizeStepPriorities();
                    }
                },
                normalizeStepPriorities() {
                    if (!this.current || !Array.isArray(this.current.steps)) {
                        return;
                    }
                    this.current.steps.forEach((step, index) => {
                        step.priority = (index + 1) * 10;
                    });
                },
                preparePipeline(pipeline) {
                    const copy = clone(pipeline);
                    copy.steps = (copy.steps || []).map(prepareItem);
                    copy.triggers = (copy.triggers || []).map(prepareItem);
                    copy.actions = (copy.actions || []).map(prepareItem);
                    copy.runs = decorateRuns(copy.runs || pipeline.runs || []);
                    return copy;
                },
                triggerTitle(code) {
                    const item = this.catalog.triggers.find(t => t.code === code);
                    return item ? item.description : '';
                },
                stepTitle(code) {
                    const item = this.catalog.steps.find(t => t.code === code);
                    return item ? item.description : '';
                },
                actionTitle(code) {
                    const item = this.catalog.actions.find(t => t.code === code);
                    return item ? item.description : '';
                },
                selectPipeline(id) {
                    this.selectedId = id;
                    this.selectedPreset = '';
                },
                addTrigger() {
                    if (!this.selectedTrigger) return;
                    const tpl = this.catalog.triggers.find(item => item.code === this.selectedTrigger);
                    this.current.triggers.push({
                        code: tpl.code,
                        parameters: clone(tpl.parameters_schema && tpl.parameters_schema.defaults ? tpl.parameters_schema.defaults : {}),
                        parameters_json: JSON.stringify({}, null, 2),
                        instruction: '',
                    });
                    this.selectedTrigger = '';
                    this.refreshSortables();
                },
                addStep() {
                    if (!this.selectedStep) return;
                    const tpl = this.catalog.steps.find(item => item.code === this.selectedStep);
                    this.current.steps.push({
                        code: tpl.code,
                        priority: (this.current.steps.length + 1) * 10,
                        enabled: true,
                        parameters: {},
                        parameters_json: JSON.stringify({}, null, 2),
                        instruction: '',
                    });
                    this.selectedStep = '';
                    this.normalizeStepPriorities();
                    this.refreshSortables();
                },
                addPromptStep() {
                    if (!this.current) return;
                    if (!this.selectedPrompt) return;
                    const prompt = this.promptTemplates.find(item => item.name === this.selectedPrompt);
                    if (!prompt) {
                        this.selectedPrompt = '';
                        return;
                    }
                    const mode = this.detectPromptMode(prompt);
                    const outputKeyBase = this.slugifyKey(prompt.name || 'prompt');
                    const outputKey = mode === 'image' ? `${outputKeyBase}_image` : `${outputKeyBase}_html`;
                    const parameters = {
                        template_name: prompt.name,
                        mode,
                        context_mapping: {},
                        extra_variables: {},
                        output_key: outputKey,
                        store_prompt: true,
                        markdown_to_html: mode === 'text',
                        parse_json: false,
                        json_fields: {},
                    };
                    this.current.steps.push({
                        code: 'GENERIC_PROMPT',
                        priority: (this.current.steps.length + 1) * 10,
                        enabled: true,
                        parameters,
                        parameters_json: JSON.stringify(parameters, null, 2),
                        instruction: `AI-–ø—Ä–æ–º—Ç: ${prompt.name}`,
                    });
                    this.selectedPrompt = '';
                    this.normalizeStepPriorities();
                    this.refreshSortables();
                },
                addAction() {
                    if (!this.selectedAction) return;
                    const tpl = this.catalog.actions.find(item => item.code === this.selectedAction);
                    this.current.actions.push({
                        code: tpl.code,
                        parameters: {},
                        parameters_json: JSON.stringify({}, null, 2),
                        instruction: '',
                    });
                    this.selectedAction = '';
                    this.refreshSortables();
                },
                slugifyKey(value) {
                    return (value || '')
                        .toString()
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '_')
                        .replace(/^_+|_+$/g, '') || 'prompt_output';
                },
                detectPromptMode(prompt) {
                    const name = (prompt.name || '').toLowerCase();
                    const category = (prompt.category || '').toLowerCase();
                    if (name.includes('image') || name.includes('–∏–∑–æ–±—Ä–∞–∂') || category === 'image') {
                        return 'image';
                    }
                    return 'text';
                },
                removeTrigger(index) {
                    this.current.triggers.splice(index, 1);
                    this.refreshSortables();
                },
                removeStep(index) {
                    this.current.steps.splice(index, 1);
                    this.normalizeStepPriorities();
                    this.refreshSortables();
                },
                removeAction(index) {
                    this.current.actions.splice(index, 1);
                    this.refreshSortables();
                },
                openRunModal() {
                    if (!this.current) return;
                    this.runModal.zodiacSign = '';
                    this.runModal.payloadText = this.lastPayloadInput || '{}';
                    this.runModal.error = '';
                    this.showRunModal = true;
                    this.$nextTick(() => {
                        const input = this.$refs.runPayloadInput;
                        if (input && typeof input.focus === 'function') {
                            input.focus();
                        }
                    });
                },
                closeRunModal() {
                    this.showRunModal = false;
                    this.runModal.error = '';
                },
                confirmRunModal() {
                    if (!this.current) return;
                    if (!this.runModal.zodiacSign) {
                        this.runModal.error = '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞';
                        return;
                    }
                    let payloadObject = {};
                    const raw = (this.runModal.payloadText || '').trim();
                    if (raw) {
                        try {
                            payloadObject = JSON.parse(raw);
                        } catch (err) {
                            this.runModal.error = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON payload';
                            return;
                        }
                    }
                    if (typeof payloadObject !== 'object' || Array.isArray(payloadObject) || payloadObject === null) {
                        payloadObject = {};
                    }
                    payloadObject.zodiac_sign = this.runModal.zodiacSign;
                    this.closeRunModal();
                    this.executeRun(payloadObject);
                },
                syncTriggerParameters(trigger) {
                    try {
                        trigger.parameters = JSON.parse(trigger.parameters_json || '{}');
                    } catch (err) {
                        this.showToast('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞', false);
                    }
                },
                syncStepParameters(step) {
                    try {
                        step.parameters = JSON.parse(step.parameters_json || '{}');
                    } catch (err) {
                        this.showToast('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —à–∞–≥–∞', false);
                    }
                },
                syncActionParameters(action) {
                    try {
                        action.parameters = JSON.parse(action.parameters_json || '{}');
                    } catch (err) {
                        this.showToast('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–µ–π—Å—Ç–≤–∏—è', false);
                    }
                },
                async fetchPipeline(id) {
                    try {
                        const response = await fetch(window.PIPELINE_ENDPOINTS.detail(id), {
                            headers: { 'Accept': 'application/json' }
                        });
                        if (!response.ok) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω');
                        }
                        const data = await response.json();
                        const pipelineData = {
                            ...data.pipeline,
                            runs: decorateRuns(data.pipeline.runs || []),
                        };
                        this.current = this.preparePipeline(pipelineData);
                        this.runHistory = [...(this.current.runs || [])];
                        this.updatePipelineEntry(pipelineData);
                        this.refreshSortables();
                    } catch (error) {
                        this.showToast(error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞', false);
                    }
                },
                updatePipelineEntry(pipelineData) {
                    const index = this.pipelines.findIndex(p => p.id === pipelineData.id);
                    if (index > -1) {
                        this.pipelines.splice(index, 1, { ...pipelineData });
                    } else {
                        this.pipelines.push({ ...pipelineData });
                    }
                },
                payloadForSave() {
                    const payload = clone(this.current);
                    payload.steps = payload.steps.map(item => ({
                        code: item.code,
                        priority: item.priority,
                        enabled: item.enabled,
                        parameters: item.parameters || {},
                        instruction: item.instruction || '',
                    }));
                    payload.triggers = payload.triggers.map(item => ({
                        code: item.code,
                        parameters: item.parameters || {},
                        instruction: item.instruction || '',
                    }));
                    payload.actions = payload.actions.map(item => ({
                        code: item.code,
                        parameters: item.parameters || {},
                        instruction: item.instruction || '',
                    }));
                    return payload;
                },
                async savePipeline() {
                    if (!this.current) return;
                    try {
                        const response = await fetch(window.PIPELINE_ENDPOINTS.detail(this.current.id), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': window.CSRF_TOKEN,
                                'Accept': 'application/json',
                            },
                            body: JSON.stringify(this.payloadForSave()),
                        });
                        if (!response.ok) {
                            throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                        }
                        const data = await response.json();
                        const pipelineData = {
                            ...data.pipeline,
                            runs: decorateRuns(data.pipeline.runs || []),
                        };
                        const updated = this.preparePipeline(pipelineData);
                        this.current = updated;
                        this.runHistory = [...(updated.runs || [])];
                        this.updatePipelineEntry(pipelineData);
                        this.refreshSortables();
                        this.showToast('–ü–∞–π–ø–ª–∞–π–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω', true);
                    } catch (error) {
                        this.showToast(error.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', false);
                    }
                },
                async createPipeline() {
                    let name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞', '–ù–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω');
                    if (!name || !name.trim()) {
                        const now = new Date();
                        const formatted = now.toLocaleString('ru-RU', {
                            hour12: false,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                        }).replace(',', '');
                        name = `–ù–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω ${formatted}`;
                    }
                    name = name.trim();
                    try {
                        const response = await fetch(window.PIPELINE_ENDPOINTS.list, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': window.CSRF_TOKEN,
                                'Accept': 'application/json',
                            },
                            body: JSON.stringify({ name }),
                        });
                        if (!response.ok) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω');
                        }
                        const data = await response.json();
                        const pipeline = {
                            ...data.pipeline,
                            runs: [],
                        };
                        this.pipelines.push(pipeline);
                        this.current = this.preparePipeline(pipeline);
                        this.selectedId = pipeline.id;
                        this.runHistory = [];
                        this.selectedPreset = '';
                        this.refreshSortables();
                        this.showToast('–ü–∞–π–ø–ª–∞–π–Ω —Å–æ–∑–¥–∞–Ω', true);
                    } catch (error) {
                        this.showToast(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è', false);
                    }
                },
                async createPipelineFromPreset() {
                    if (!this.selectedPreset) {
                        this.showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç', false);
                        return;
                    }
                    const preset = this.presets.find(item => item.slug === this.selectedPreset);
                    if (!preset) {
                        this.showToast('–ü—Ä–µ—Å–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', false);
                        return;
                    }
                    let name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ –ø–æ –ø—Ä–µ—Å–µ—Ç—É', preset.name || '–ù–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω');
                    if (name === null) {
                        return;
                    }
                    if (!name || !name.trim()) {
                        const now = new Date();
                        const formatted = now.toLocaleString('ru-RU', {
                            hour12: false,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                        }).replace(',', '');
                        name = `${preset.name || '–ù–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω'} ${formatted}`;
                    }
                    name = name.trim();
                    try {
                        const response = await fetch(window.PIPELINE_ENDPOINTS.fromPreset, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': window.CSRF_TOKEN,
                                'Accept': 'application/json',
                            },
                            body: JSON.stringify({
                                preset: preset.slug,
                                name,
                                description: preset.description,
                            }),
                        });
                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω –ø–æ –ø—Ä–µ—Å–µ—Ç—É');
                        }
                        const data = await response.json();
                        const pipeline = {
                            ...data.pipeline,
                            runs: decorateRuns(data.pipeline.runs || []),
                        };
                        this.updatePipelineEntry(pipeline);
                        this.current = this.preparePipeline(pipeline);
                        this.selectedId = pipeline.id;
                        this.runHistory = [...(this.current.runs || [])];
                        this.selectedPreset = '';
                        this.refreshSortables();
                        this.showToast('–ü–∞–π–ø–ª–∞–π–Ω —Å–æ–∑–¥–∞–Ω –ø–æ –ø—Ä–µ—Å–µ—Ç—É', true);
                    } catch (error) {
                        this.showToast(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ –ø—Ä–µ—Å–µ—Ç—É', false);
                    }
                },
                async deletePipeline() {
                    if (!this.current || !confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω?')) return;
                    try {
                        const response = await fetch(window.PIPELINE_ENDPOINTS.detail(this.current.id), {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': window.CSRF_TOKEN,
                                'Accept': 'application/json',
                            },
                        });
                        if (!response.ok) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω');
                        }
                        this.pipelines = this.pipelines.filter(p => p.id !== this.current.id);
                        if (this.pipelines.length) {
                            const next = this.pipelines[0];
                            this.selectedId = next.id;
                            this.current = this.preparePipeline(next);
                            this.runHistory = [...(this.current.runs || [])];
                            this.refreshSortables();
                        } else {
                            this.selectedId = null;
                            this.current = null;
                            this.runHistory = [];
                            this.destroySortables();
                        }
                        this.showToast('–ü–∞–π–ø–ª–∞–π–Ω —É–¥–∞–ª–µ–Ω', true);
                    } catch (error) {
                        this.showToast(error.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', false);
                    }
                },
                async executeRun(payload = {}) {
                    if (!this.current) return;
                    let payloadObject = {};
                    if (typeof payload === 'object' && payload !== null && !Array.isArray(payload)) {
                        payloadObject = payload;
                    }
                    this.lastPayloadInput = JSON.stringify(payloadObject, null, 2);
                    this.showToast('–ó–∞–ø—É—Å–∫...', true);
                    try {
                        const response = await fetch(window.PIPELINE_ENDPOINTS.run(this.current.id), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': window.CSRF_TOKEN,
                                'Accept': 'application/json',
                            },
                            body: JSON.stringify(payloadObject),
                        });
                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞');
                        }
                        const data = await response.json();
                        const runEntry = decorateRuns([data.run || {}])[0] || null;
                        if (runEntry) {
                            this.runHistory = [runEntry, ...this.runHistory].slice(0, 5);
                            const index = this.pipelines.findIndex(p => p.id === this.current.id);
                            if (index > -1) {
                                const existing = this.pipelines[index];
                                const updatedRuns = [runEntry, ...(existing.runs || [])].slice(0, 5);
                                this.pipelines.splice(index, 1, { ...existing, runs: updatedRuns });
                            }
                            if (this.current) {
                                this.current.runs = [runEntry, ...(this.current.runs || [])].slice(0, 5);
                            }
                        }
                        const status = data.run?.status || 'unknown';
                        if (status === 'success') {
                            this.showToast('–ü–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ', true);
                        } else if (status === 'failed') {
                            this.showToast('–ü–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π', false);
                        } else {
                            this.showToast(`–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${status}`, true);
                        }
                    } catch (error) {
                        this.showToast(error.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞', false);
                    }
                },
                repeatRun(run) {
                    if (!run || !run.payload) {
                        this.showToast('–ü–æ–≤—Ç–æ—Ä –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω: payload –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', false);
                        return;
                    }
                    const payloadClone = JSON.parse(JSON.stringify(run.payload || {}));
                    this.executeRun(payloadClone);
                },
                showToast(message, success) {
                    this.toast = { message, success };
                    setTimeout(() => {
                        this.toast = null;
                    }, 4000);
                }
            }
        }).mount('#pipeline-builder-app');
    })();
</script>
<style>
    .sortable-ghost {
        opacity: 0.5;
    }

    .sortable-chosen {
        cursor: grabbing !important;
    }

    .drag-handle {
        font-weight: 700;
        letter-spacing: 0.1em;
    }
</style>
{% endblock %}

