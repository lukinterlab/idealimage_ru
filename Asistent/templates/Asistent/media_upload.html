{% extends "base_tailwind.html" %}
{% load static %}

{% block title %}–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <nav class="flex mb-6" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'Visitor:superuser_dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-300 hover:text-white transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                        </svg>
                        –ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <a href="{% url 'asistent:admin_dashboard' %}" class="ml-1 text-sm font-medium text-gray-300 hover:text-white md:ml-2">AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤</h1>
            <p class="text-gray-400">–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-xl p-6">
                    <h2 class="text-xl font-semibold mb-4">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h2>
                    
                    <form id="mediaUploadForm" enctype="multipart/form-data" class="space-y-6">
                        {% csrf_token %}
                        
                        <!-- –¢–∏–ø –º–µ–¥–∏–∞ -->
                        <div>
                            <label class="block text-sm font-medium mb-2">–¢–∏–ø –º–µ–¥–∏–∞</label>
                            <select name="media_type" id="mediaType" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="audio">üéµ –ê—É–¥–∏–æ</option>
                                <option value="video">üé¨ –í–∏–¥–µ–æ</option>
                                <option value="image">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                            </select>
                        </div>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                        <div>
                            <label class="block text-sm font-medium mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" name="title" id="title" required
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞">
                        </div>

                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                        <div>
                            <label class="block text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <textarea name="description" id="description" rows="3"
                                      class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                      placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–π–ª–∞"></textarea>
                        </div>

                        <!-- –§–∞–π–ª -->
                        <div>
                            <label class="block text-sm font-medium mb-2">–§–∞–π–ª</label>
                            <div class="relative">
                                <input type="file" name="file" id="fileInput" required
                                       accept="audio/*,video/*,image/*"
                                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700">
                            </div>
                            <p class="text-sm text-gray-400 mt-1">
                                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP3, WAV, MP4, AVI, JPG, PNG, GIF
                            </p>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                        <button type="submit" id="uploadBtn"
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                            <span id="uploadText">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</span>
                            <span id="uploadingText" class="hidden">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="space-y-6">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:</span>
                            <span class="font-semibold">{{ total_files }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</span>
                            <span class="font-semibold text-green-400">{{ processed_files }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ:</span>
                            <span class="font-semibold text-yellow-400">{{ processing_files }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">–û—à–∏–±–∫–∏:</span>
                            <span class="font-semibold text-red-400">{{ failed_files }}</span>
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4">‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
                    <ul class="space-y-2 text-sm text-gray-300">
                        <li>‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 100 MB</li>
                        <li>‚Ä¢ –ê—É–¥–∏–æ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω—ã</li>
                        <li>‚Ä¢ –í–∏–¥–µ–æ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞</li>
                        <li>‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ</li>
                        <li>‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ AI-—á–∞—Ç–µ</li>
                    </ul>
                </div>

                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                    <div class="space-y-3">
                        <a href="{% url 'asistent:ai_chat' %}" 
                           class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-4 rounded-lg transition-colors">
                            üí¨ AI-–ß–∞—Ç
                        </a>
                        <a href="{% url 'asistent:admin_dashboard' %}" 
                           class="block w-full bg-gray-600 hover:bg-gray-700 text-white text-center py-2 px-4 rounded-lg transition-colors">
                            üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
        <div class="mt-8">
            <div class="bg-gray-800 rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4">üìã –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h2>
                
                {% if uploaded_files %}
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-3 px-4">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th class="text-left py-3 px-4">–¢–∏–ø</th>
                                    <th class="text-left py-3 px-4">–†–∞–∑–º–µ—Ä</th>
                                    <th class="text-left py-3 px-4">–°—Ç–∞—Ç—É—Å</th>
                                    <th class="text-left py-3 px-4">–î–∞—Ç–∞</th>
                                    <th class="text-left py-3 px-4">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in uploaded_files %}
                                <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td class="py-3 px-4">
                                        <div class="font-medium">{{ file.title }}</div>
                                        {% if file.description %}
                                            <div class="text-gray-400 text-xs">{{ file.description|truncatechars:50 }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded text-xs
                                            {% if file.media_type == 'audio' %}bg-blue-600 text-blue-100
                                            {% elif file.media_type == 'video' %}bg-purple-600 text-purple-100
                                            {% else %}bg-green-600 text-green-100{% endif %}">
                                            {{ file.get_media_type_display }}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">{{ file.get_file_size_mb }} MB</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded text-xs
                                            {% if file.status == 'processed' %}bg-green-600 text-green-100
                                            {% elif file.status == 'processing' %}bg-yellow-600 text-yellow-100
                                            {% elif file.status == 'failed' %}bg-red-600 text-red-100
                                            {% else %}bg-gray-600 text-gray-100{% endif %}">
                                            {{ file.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">{{ file.created_at|date:"d.m.Y H:i" }}</td>
                                    <td class="py-3 px-4">
                                        <div class="flex space-x-2">
                                            {% if file.status == 'processed' and file.transcript_text %}
                                                <button onclick="showTranscript({{ file.id }})" 
                                                        class="text-blue-400 hover:text-blue-300 text-xs">
                                                    üìÑ –¢–µ–∫—Å—Ç
                                                </button>
                                            {% endif %}
                                            <button onclick="deleteFile({{ file.id }})" 
                                                    class="text-red-400 hover:text-red-300 text-xs">
                                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-4">üìÅ</div>
                        <p>–§–∞–π–ª—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ -->
<div id="transcriptModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 rounded-xl max-w-2xl w-full max-h-96 overflow-hidden">
            <div class="p-6 border-b border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">üìÑ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</h3>
                    <button onclick="closeTranscript()" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-64">
                <div id="transcriptContent" class="text-gray-300 whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>
</div>

<script>
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∑–∫–∏
document.getElementById('mediaUploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadText = document.getElementById('uploadText');
    const uploadingText = document.getElementById('uploadingText');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    uploadBtn.disabled = true;
    uploadText.classList.add('hidden');
    uploadingText.classList.remove('hidden');
    
    try {
        const response = await fetch('{% url "asistent:api_media_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        uploadBtn.disabled = false;
        uploadText.classList.remove('hidden');
        uploadingText.classList.add('hidden');
    }
});

// –ü–æ–∫–∞–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
function showTranscript(fileId) {
    // TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é —á–µ—Ä–µ–∑ AJAX
    document.getElementById('transcriptContent').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏...';
    document.getElementById('transcriptModal').classList.remove('hidden');
}

function closeTranscript() {
    document.getElementById('transcriptModal').classList.add('hidden');
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
function deleteFile(fileId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')) {
        // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ AJAX
        showNotification('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}
