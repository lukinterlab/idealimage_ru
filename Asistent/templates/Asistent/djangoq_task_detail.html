{% extends 'base_tailwind.html' %}
{% load static %}
{% load djangoq_filters %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Заголовок и кнопки -->
        <div class="mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
                <div>
                    <h1 class="text-4xl font-black text-white mb-2">{{ title }}</h1>
                    <p class="text-xl text-gray-300">Подробная информация о задаче Django-Q</p>
                </div>
                <div class="flex gap-3 flex-wrap">
                    {% if task_type == 'queued' %}
                    <a href="{% url 'asistent:djangoq_tasks_queued' %}" 
                       class="px-6 py-3 bg-white/10 hover:bg-white/20 backdrop-blur-md text-white font-semibold rounded-lg transition-colors border border-white/20 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        К списку
                    </a>
                    <form method="post" action="{% url 'asistent:djangoq_task_run_now' task.id %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" 
                                class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors flex items-center gap-2 shadow-lg">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                            </svg>
                            Запустить сейчас
                        </button>
                    </form>
                    <form method="post" action="{% url 'asistent:djangoq_task_delete' task.id %}" class="inline" onsubmit="return confirm('Вы уверены?')">
                        {% csrf_token %}
                        <button type="submit" 
                                class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center gap-2 shadow-lg">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            Удалить
                        </button>
                    </form>
                    {% else %}
                    <a href="{% if task_type == 'active' %}{% url 'asistent:djangoq_tasks_active' %}{% elif task_type == 'recent' %}{% url 'asistent:djangoq_tasks_recent' %}{% else %}{% url 'asistent:djangoq_tasks_all' %}{% endif %}" 
                       class="px-6 py-3 bg-white/10 hover:bg-white/20 backdrop-blur-md text-white font-semibold rounded-lg transition-colors border border-white/20 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        К списку
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Левая колонка -->
            <div class="space-y-8">
                
                <!-- Основная информация -->
                <div class="bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 overflow-hidden shadow-2xl">
                    <div class="bg-gradient-to-r {% if task_type == 'queued' %}from-yellow-600 to-amber-700{% elif task_type == 'active' %}from-blue-600 to-cyan-700{% elif model_name == 'Success' or task_type == 'recent' %}from-green-600 to-emerald-700{% else %}from-red-600 to-rose-700{% endif %} px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"></path>
                                <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"></path>
                                <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"></path>
                            </svg>
                            Основная информация
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between items-center py-2 border-b border-white/10">
                            <span class="text-gray-400">ID задачи:</span>
                            <code class="px-3 py-1 bg-purple-500/30 text-purple-200 rounded font-mono">#{{ task.id }}</code>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-white/10">
                            <span class="text-gray-400">Модель:</span>
                            <span class="px-3 py-1 bg-gray-500/30 text-gray-200 rounded font-semibold">{{ model_name }}</span>
                        </div>
                        <div class="flex justify-between items-start py-2 border-b border-white/10">
                            <span class="text-gray-400">Название:</span>
                            <div class="text-right">
                                <span class="text-white font-semibold block">{{ task.func|task_formatted }}</span>
                                <span class="text-cyan-300 text-sm">{{ task.func|task_description }}</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-start py-2">
                            <span class="text-gray-400">Функция:</span>
                            <code class="px-2 py-1 bg-blue-500/20 text-blue-200 rounded text-sm font-mono text-right break-all">{{ task.func }}</code>
                        </div>
                        {% if task.group %}
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-400">Группа:</span>
                            <span class="text-white">{{ task.group }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Статус (только для OrmQ) -->
                {% if model_name == 'OrmQ' %}
                <div class="bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 overflow-hidden shadow-2xl">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-700 px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            Статус
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if task.lock %}
                        <div class="bg-blue-500/20 border border-blue-500/30 rounded-lg p-5">
                            <div class="flex items-center gap-3 mb-2">
                                <svg class="w-6 h-6 text-blue-300 animate-spin" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-xl font-bold text-blue-200">Выполняется сейчас</span>
                            </div>
                            <p class="text-blue-100">Запущена: {{ task.lock|timesince }} назад</p>
                        </div>
                        {% else %}
                        <div class="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-5">
                            <div class="flex items-center gap-3 mb-2">
                                <svg class="w-6 h-6 text-yellow-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-xl font-bold text-yellow-200">В очереди</span>
                            </div>
                            <p class="text-yellow-100">Ожидает выполнения</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
            </div>
            
            <!-- Правая колонка -->
            <div class="space-y-8">
                
                <!-- Время выполнения -->
                {% if model_name == 'Success' or model_name == 'Failure' %}
                <div class="bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 overflow-hidden shadow-2xl">
                    <div class="bg-gradient-to-r {% if model_name == 'Success' %}from-green-600 to-emerald-700{% else %}from-red-600 to-rose-700{% endif %} px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            Время выполнения
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between items-center py-2 border-b border-white/10">
                            <span class="text-gray-400">Запущена:</span>
                            <span class="text-white font-semibold">{{ task.started|date:"d.m.Y H:i:s" }}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-white/10">
                            <span class="text-gray-400">Завершена:</span>
                            <span class="text-white font-semibold">{{ task.stopped|date:"d.m.Y H:i:s" }}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-white/10">
                            <span class="text-gray-400">Время выполнения:</span>
                            {% if task.time_taken %}
                            <span class="px-3 py-1 bg-blue-500/30 text-blue-200 rounded font-semibold">{{ task.time_taken|floatformat:2 }} сек</span>
                            {% else %}
                            <span class="px-3 py-1 bg-gray-500/30 text-gray-400 rounded">N/A</span>
                            {% endif %}
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-400">Назад:</span>
                            <span class="text-white">{{ task.stopped|timesince }} назад</span>
                        </div>
                    </div>
                </div>
                
                <!-- Результат -->
                <div class="bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 overflow-hidden shadow-2xl">
                    <div class="bg-gradient-to-r {% if model_name == 'Success' %}from-green-600 to-emerald-700{% else %}from-red-600 to-rose-700{% endif %} px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            {% if model_name == 'Success' %}
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Результат выполнения
                            {% else %}
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            Ошибка
                            {% endif %}
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if task.result %}
                        <pre class="bg-black/30 p-4 rounded-lg overflow-x-auto max-h-80 {% if model_name == 'Failure' %}text-red-300{% else %}text-green-300{% endif %} text-sm font-mono">{{ task.result }}</pre>
                        {% else %}
                        <p class="text-gray-400 text-center py-4">Результат отсутствует</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
            </div>
            
        </div>
        
        <!-- Параметры (полная ширина) -->
        <div class="mt-8 bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 overflow-hidden shadow-2xl">
            <div class="bg-gradient-to-r from-gray-700 to-gray-900 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    Параметры выполнения
                </h2>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-white mb-3">Args (позиционные аргументы):</h3>
                    {% if task.args %}
                    <pre class="bg-black/30 p-4 rounded-lg overflow-x-auto text-blue-300 text-sm font-mono">{{ task.args }}</pre>
                    {% else %}
                    <p class="text-gray-400 italic">Нет аргументов</p>
                    {% endif %}
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-white mb-3">Kwargs (именованные аргументы):</h3>
                    {% if task.kwargs %}
                    <pre class="bg-black/30 p-4 rounded-lg overflow-x-auto text-purple-300 text-sm font-mono">{{ task.kwargs }}</pre>
                    {% else %}
                    <p class="text-gray-400 italic">Нет аргументов</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}
