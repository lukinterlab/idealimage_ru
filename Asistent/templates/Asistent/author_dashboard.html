{% extends 'Asistent/base.html' %}

{% block title %}Личный кабинет автора{% endblock %}

{% block content %}
<div class="row">
    <!-- Статистика -->
    <div class="col-md-12 mb-4">
        <h2 class="mb-4">
            <i class="fas fa-tachometer-alt"></i> Добро пожаловать, {{ user.get_full_name|default:user.username }}!
        </h2>
    </div>
    
    <!-- Карточки статистики -->
    <div class="col-md-3 mb-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-tasks fa-2x text-primary mb-3"></i>
                <h3>{{ stats.tasks_in_progress }}</h3>
                <p class="text-muted">Заданий в работе</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                <h3>{{ stats.total_completed }}</h3>
                <p class="text-muted">Выполнено</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-ruble-sign fa-2x text-warning mb-3"></i>
                <h3>{{ balance }} ₽</h3>
                <p class="text-muted">Баланс</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-money-bill-wave fa-2x text-info mb-3"></i>
                <h3>{{ stats.total_earned }} ₽</h3>
                <p class="text-muted">Всего заработано</p>
            </div>
        </div>
    </div>
</div>

<!-- Уведомления -->
{% if notifications %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-bell"></i> Новые уведомления
            </div>
            <div class="card-body">
                {% for notification in notifications %}
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ notification.title }}</strong><br>
                        {{ notification.message|truncatewords:30 }}
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="markAsRead({{ notification.id }})">
                        <i class="fas fa-check"></i> Прочитано
                    </button>
                </div>
                {% endfor %}
                <a href="{% url 'Visitor:notifications' %}" class="btn btn-primary">
                    Все уведомления
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Мои задания -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="fas fa-clipboard-list"></i> Мои задания
            </div>
            <div class="card-body">
                {% if my_assignments %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Задание</th>
                                <th>Статус</th>
                                <th>Срок</th>
                                <th>Награда</th>
                                <th>Взято</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in my_assignments %}
                            <tr>
                                <td>
                                    <strong>{{ assignment.task.title }}</strong><br>
                                    <small class="text-muted">{{ assignment.task.description|truncatewords:15 }}</small>
                                </td>
                                <td>
                                    <span class="badge badge-custom 
                                        {% if assignment.status == 'in_progress' %}bg-warning
                                        {% elif assignment.status == 'completed' %}bg-info
                                        {% elif assignment.status == 'rejected_by_ai' %}bg-danger
                                        {% elif assignment.status == 'approved' %}bg-success
                                        {% endif %}">
                                        {{ assignment.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {{ assignment.task.deadline|date:"d.m.Y H:i" }}
                                    {% if assignment.task.is_overdue %}
                                    <br><span class="badge bg-danger">Просрочено</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ assignment.task.reward }} ₽</strong></td>
                                <td><small>{{ assignment.taken_at|date:"d.m H:i" }}</small></td>
                                <td>
                                    {% if assignment.status == 'in_progress' %}
                                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#submitModal{{ assignment.id }}">
                                        <i class="fas fa-paper-plane"></i> Выполнено
                                    </button>
                                    {% elif assignment.status == 'rejected_by_ai' %}
                                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#viewRejectionModal{{ assignment.id }}">
                                        <i class="fas fa-info-circle"></i> Причина
                                    </button>
                                    {% elif assignment.status == 'completed' %}
                                    <span class="text-info"><i class="fas fa-clock"></i> На модерации</span>
                                    {% elif assignment.status == 'approved' %}
                                    <span class="text-success"><i class="fas fa-check"></i> Одобрено</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center text-muted">У вас пока нет заданий в работе</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Доступные задания -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-star"></i> Доступные задания
            </div>
            <div class="card-body">
                {% if available_tasks %}
                <div class="row">
                    {% for task in available_tasks %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">{{ task.title }}</h5>
                                    <span class="badge bg-primary">{{ task.get_completions_count }}/{{ task.max_completions }}</span>
                                </div>
                                <p class="card-text">{{ task.description|truncatewords:25 }}</p>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-folder"></i> {{ task.category.title|default:"Без категории" }}</li>
                                    <li><i class="fas fa-align-left"></i> Минимум {{ task.required_word_count }} слов</li>
                                    <li><i class="fas fa-calendar"></i> До {{ task.deadline|date:"d.m.Y H:i" }}</li>
                                    <li><i class="fas fa-ruble-sign"></i> <strong>{{ task.reward }} ₽</strong></li>
                                    <li><i class="fas fa-users"></i> Мест осталось: <strong>{{ task.max_completions|add:"-"|add:task.get_completions_count }}</strong></li>
                                </ul>
                                <div class="d-flex gap-2">
                                <form method="post" action="{% url 'Visitor:take_task' task.id %}" class="flex-fill">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success w-100">
                                            <i class="fas fa-hand-point-right"></i> Взять в работу
                                        </button>
                                    </form>
                                <form method="post" action="{% url 'Visitor:reject_task' task.id %}" class="flex-fill">
                                        {% csrf_token %}
                                        <button type="submit" 
                                                class="btn btn-outline-secondary w-100"
                                                onclick="return confirm('Отклонить задание? Оно больше не будет отображаться.')">
                                            <i class="fas fa-times"></i> Отклонить
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-muted">Нет доступных заданий</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна для сдачи заданий -->
{% for assignment in my_assignments %}
{% if assignment.status == 'in_progress' %}
<div class="modal fade" id="submitModal{{ assignment.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Сдать задание: {{ assignment.task.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
                    <form method="post" action="{% url 'Visitor:submit_assignment' assignment.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>После отправки:</strong><br>
                        AI-Ассистент автоматически проверит вашу статью на соответствие критериям задания.
                        Результат придёт в уведомлениях.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ID статьи</label>
                        <input type="number" name="article_id" class="form-control" required>
                        <small class="text-muted">Введите ID вашей опубликованной статьи</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-robot"></i> Отправить на AI модерацию
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% if assignment.status == 'rejected_by_ai' %}
<div class="modal fade" id="viewRejectionModal{{ assignment.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Замечания AI по заданию: {{ assignment.task.title }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Статья отклонена AI-Ассистентом</strong>
                </div>
                
                {% if assignment.ai_moderation_result %}
                <h6>Оценка AI:</h6>
                <p class="h3 text-danger mb-3">{{ assignment.ai_moderation_result.score|default:"?" }}/10</p>
                {% endif %}
                
                <h6>Замечания:</h6>
                <div class="p-3 bg-light rounded">
                    <p class="mb-0" style="white-space: pre-line;">{{ assignment.rejection_reason }}</p>
                </div>
                
                <div class="mt-3 alert alert-info">
                    <i class="fas fa-lightbulb"></i> <strong>Что делать:</strong><br>
                    1. Внесите необходимые правки в статью<br>
                    2. Отправьте её повторно через форму "Выполнено"
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                {% if assignment.article %}
                <a href="{% url 'blog:post_update' assignment.article.slug %}" 
                   class="btn btn-primary" target="_blank">
                    <i class="fas fa-edit"></i> Редактировать статью
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
function markAsRead(notificationId) {
    fetch(`/asistent/notifications/${notificationId}/read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    }).then(() => {
        location.reload();
    });
}
</script>
{% endblock %}

