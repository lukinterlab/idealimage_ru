{% load static %}

<!-- ================================================================== -->
<!-- GIGACHAT CONTROL CENTER - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ö–∞–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è AI-—Å–∏—Å—Ç–µ–º–æ–π -->
<!-- ================================================================== -->

<!-- –ë–õ–û–ö 1: –ë–∞–ª–∞–Ω—Å –≤—Å–µ—Ö 4 –º–æ–¥–µ–ª–µ–π GigaChat -->
<div class="mb-8 bg-gradient-to-br from-purple-900/50 to-blue-900/50 backdrop-blur-md rounded-2xl p-6 border border-purple-500/30" id="gigachat-balance-widget">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-white flex items-center gap-3">
            ü§ñ GigaChat –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        </h2>
        <button onclick="refreshGigaChatBalance()" 
                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
            </svg>
            –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
        </button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        {% for model_key, model_data in gigachat_balances.items %}
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-5 border border-white/10 hover:border-purple-500/50 transition-all cursor-pointer"
             onclick="showModelDetails('{{ model_key }}')">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–µ–ª–∏ -->
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold text-white">
                    {{ model_data.display_name }}
                </h3>
                <span class="text-2xl">{{ model_data.status_icon }}</span>
            </div>
            
            <!-- –¢–æ–∫–µ–Ω—ã (–ö–†–£–ü–ù–û) -->
            <div class="mb-3">
                <div class="text-xs text-gray-400 mb-1">–¢–æ–∫–µ–Ω–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å:</div>
                <div class="text-3xl font-bold text-white">
                    {{ model_data.tokens_remaining|floatformat:0 }}
                </div>
                <div class="text-xs text-gray-400">
                    –∏–∑ {{ model_data.tokens_limit|floatformat:0 }}
                </div>
            </div>
            
            <!-- Progress bar -->
            <div class="w-full bg-gray-700 rounded-full h-3 mb-3">
                <div class="bg-gradient-to-r {% if model_data.status == 'ok' %}from-green-500 to-emerald-500{% elif model_data.status == 'warning' %}from-yellow-500 to-amber-500{% else %}from-red-500 to-rose-500{% endif %} h-3 rounded-full transition-all" 
                     style="width: {{ model_data.percent }}%"></div>
            </div>
            
            <!-- –ü—Ä–æ—Ü–µ–Ω—Ç -->
            <div class="text-2xl font-bold {% if model_data.status == 'ok' %}text-green-300{% elif model_data.status == 'warning' %}text-yellow-300{% else %}text-red-300{% endif %} mb-2">
                {{ model_data.percent }}%
            </div>
            
            <!-- –î–µ—Ç–∞–ª–∏ -->
            <div class="text-xs text-gray-400 space-y-1">
                <div>–ó–∞–ø—Ä–æ—Å–æ–≤: {{ model_data.total_requests }}</div>
                <div>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {{ model_data.success_rate }}%</div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-4 text-center text-gray-400 py-8">
            ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –º–æ–¥–µ–ª–µ–π
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ë–õ–û–ö 2: –°—Ç–æ–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -->
<div class="mb-8">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
        üí∞ –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ GigaChat API
    </h2>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- –°–µ–≥–æ–¥–Ω—è -->
        <div class="bg-gradient-to-br from-blue-900/50 to-cyan-900/50 backdrop-blur-md rounded-xl p-6 border border-blue-500/30">
            <div class="text-gray-300 text-sm mb-2">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="text-4xl font-bold text-white mb-3">{{ costs_today.total }}‚ÇΩ</div>
            <div class="space-y-1 text-xs">
                {% for model, cost in costs_today.breakdown.items %}
                <div class="flex justify-between text-gray-300">
                    <span>{{ model|slice:"9:" }}</span>
                    <span>{{ cost }}‚ÇΩ</span>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü -->
        <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 backdrop-blur-md rounded-xl p-6 border border-purple-500/30">
            <div class="text-gray-300 text-sm mb-2">–ü—Ä–æ–≥–Ω–æ–∑ –º–µ—Å—è—Ü</div>
            <div class="text-4xl font-bold text-white mb-3">~{{ costs_today.month_forecast|floatformat:0 }}‚ÇΩ</div>
            <div class="text-sm text-gray-300">
                –ù–∞ –æ—Å–Ω–æ–≤–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö —Ç—Ä–∞—Ç
            </div>
        </div>
        
        <!-- –≠–∫–æ–Ω–æ–º–∏—è -->
        <div class="bg-gradient-to-br from-green-900/50 to-emerald-900/50 backdrop-blur-md rounded-xl p-6 border border-green-500/30">
            <div class="text-gray-300 text-sm mb-2">–≠–∫–æ–Ω–æ–º–∏—è</div>
            <div class="text-4xl font-bold text-green-300 mb-3">-{{ costs_today.savings_percent }}%</div>
            <div class="text-sm text-gray-300">
                vs –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ Max
            </div>
        </div>
    </div>
</div>

<!-- –ë–õ–û–ö 3: –ù–∞–≤–∏–≥–∞—Ü–∏—è AI-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (6 –∫–∞—Ä—Ç–æ—á–µ–∫) -->
<div class="mb-8">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
        üéØ AI –ü—Ä–æ—Ü–µ—Å—Å—ã
    </h2>
    
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <!-- –ó–∞–¥–∞—á–∏ AI -->
        <a href="{{ navigation_stats.tasks.url }}" 
           class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:border-blue-500/50 transition-all group">
            <div class="text-4xl mb-3">üìã</div>
            <h3 class="text-lg font-bold text-white mb-2 group-hover:text-blue-300 transition-colors">–ó–∞–¥–∞—á–∏ AI</h3>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">–ê–∫—Ç–∏–≤–Ω—ã—Ö:</span>
                <span class="text-white font-bold">{{ navigation_stats.tasks.active }}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-400">
                <span>–°–µ–≥–æ–¥–Ω—è:</span>
                <span>{{ navigation_stats.tasks.completed_today }}</span>
            </div>
        </a>
        
        <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
        <a href="{{ navigation_stats.schedules.url }}" 
           class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:border-green-500/50 transition-all group">
            <div class="text-4xl mb-3">ü§ñ</div>
            <h3 class="text-lg font-bold text-white mb-2 group-hover:text-green-300 transition-colors">–†–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">–ê–∫—Ç–∏–≤–Ω—ã—Ö:</span>
                <span class="text-white font-bold">{{ navigation_stats.schedules.active }}</span>
            </div>
            {% if navigation_stats.schedules.next_run %}
            <div class="text-xs text-gray-400 mt-1">
                –°–ª–µ–¥: {{ navigation_stats.schedules.next_run|date:"d.m H:i" }}
            </div>
            {% endif %}
        </a>
        
        <!-- –ú–æ–¥–µ—Ä–∞—Ü–∏—è -->
        <a href="{{ navigation_stats.moderation.url }}" 
           class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:border-yellow-500/50 transition-all group">
            <div class="text-4xl mb-3">‚úì</div>
            <h3 class="text-lg font-bold text-white mb-2 group-hover:text-yellow-300 transition-colors">–ú–æ–¥–µ—Ä–∞—Ü–∏—è</h3>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">–ñ–¥—É—Ç:</span>
                <span class="text-white font-bold">{{ navigation_stats.moderation.pending }}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-400">
                <span>–°–µ–≥–æ–¥–Ω—è:</span>
                <span>{{ navigation_stats.moderation.moderated_today }}</span>
            </div>
        </a>
        
        <!-- SEO –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è -->
        <a href="{{ navigation_stats.seo.url }}" 
           class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:border-purple-500/50 transition-all group">
            <div class="text-4xl mb-3">üöÄ</div>
            <h3 class="text-lg font-bold text-white mb-2 group-hover:text-purple-300 transition-colors">SEO</h3>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">FAQ –±–ª–æ–∫–∏:</span>
                <span class="text-white font-bold">{{ navigation_stats.seo.with_faq }}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-400">
                <span>–í—Å–µ–≥–æ:</span>
                <span>{{ navigation_stats.seo.total }}</span>
            </div>
        </a>
        
        <!-- –î–æ–Ω–∞—Ç—ã -->
        <a href="{{ navigation_stats.donations.url }}" 
           class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:border-pink-500/50 transition-all group">
            <div class="text-4xl mb-3">üí∞</div>
            <h3 class="text-lg font-bold text-white mb-2 group-hover:text-pink-300 transition-colors">–î–æ–Ω–∞—Ç—ã</h3>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">–û–∂–∏–¥–∞—é—Ç:</span>
                <span class="text-white font-bold">{{ navigation_stats.donations.pending_amount|floatformat:0 }}‚ÇΩ</span>
            </div>
        </a>
        
        <!-- –†–µ–∫–ª–∞–º–∞ -->
        <a href="{{ navigation_stats.advertising.url }}" 
           class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 hover:border-orange-500/50 transition-all group">
            <div class="text-4xl mb-3">üì¢</div>
            <h3 class="text-lg font-bold text-white mb-2 group-hover:text-orange-300 transition-colors">–†–µ–∫–ª–∞–º–∞</h3>
            <div class="flex justify-between text-sm">
                <span class="text-gray-400">–ë–∞–Ω–Ω–µ—Ä–æ–≤:</span>
                <span class="text-white font-bold">{{ navigation_stats.advertising.active_banners }}</span>
            </div>
        </a>
    </div>
</div>

<!-- –ë–õ–û–ö 4: –°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã -->
{% if system_alerts %}
<div class="mb-8">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
        üö® –°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
    </h2>
    
    <div class="space-y-3">
        {% for alert in system_alerts %}
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border 
                    {% if alert.level == 'critical' %}border-red-500/50 bg-red-900/20{% elif alert.level == 'warning' %}border-yellow-500/50 bg-yellow-900/20{% elif alert.level == 'success' %}border-green-500/50 bg-green-900/20{% else %}border-gray-500/50{% endif %}">
            <div class="flex items-start gap-3">
                <div class="text-2xl">{{ alert.icon }}</div>
                <div class="flex-1">
                    <h3 class="font-bold 
                               {% if alert.level == 'critical' %}text-red-300{% elif alert.level == 'warning' %}text-yellow-300{% elif alert.level == 'success' %}text-green-300{% else %}text-white{% endif %} mb-1">
                        {{ alert.title }}
                    </h3>
                    <p class="text-gray-300 text-sm">{{ alert.message }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- –ë–õ–û–ö 5: –ì—Ä–∞—Ñ–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π -->
<div class="mb-8 bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
        üìà –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π
    </h2>
    
    <div class="bg-white/5 rounded-xl p-4">
        <canvas id="modelsUsageChart" height="100"></canvas>
    </div>
</div>

<!-- –ë–õ–û–ö 6: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –º–æ–¥–µ–ª—è–º (—Ç–∞–±–ª–∏—Ü–∞) -->
<div class="mb-8">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
        üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ –º–æ–¥–µ–ª—è–º
    </h2>
    
    <div class="bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-white/5 border-b border-white/20">
                    <tr>
                        <th class="px-6 py-4 text-left text-white font-semibold">–ú–æ–¥–µ–ª—å</th>
                        <th class="px-6 py-4 text-center text-white font-semibold">–ó–∞–ø—Ä–æ—Å–æ–≤</th>
                        <th class="px-6 py-4 text-center text-white font-semibold">–î–æ–ª—è</th>
                        <th class="px-6 py-4 text-center text-white font-semibold">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {% for model in model_distribution.models %}
                    <tr class="hover:bg-white/5">
                        <td class="px-6 py-4 text-white font-semibold">
                            {{ model.display_name }}
                        </td>
                        <td class="px-6 py-4 text-center text-white">
                            {{ model.requests }}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-20 bg-gray-700 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" 
                                         style="width: {{ model.percent }}%"></div>
                                </div>
                                <span class="text-white text-sm">{{ model.percent }}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold
                                       {% if model.success_rate >= 90 %}bg-green-500/20 text-green-300{% elif model.success_rate >= 70 %}bg-yellow-500/20 text-yellow-300{% else %}bg-red-500/20 text-red-300{% endif %}">
                                {{ model.success_rate }}%
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-400">
                            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –ë–õ–û–ö 7: Django-Q —Å—Ç–∞—Ç—É—Å -->
<div class="mb-8 bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
        ‚öôÔ∏è Django-Q –ö–ª–∞—Å—Ç–µ—Ä
    </h2>
    
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="text-3xl">
                {% if djangoq_health.status == 'running' %}‚úÖ{% elif djangoq_health.status == 'queued' %}üü°{% else %}‚è∏Ô∏è{% endif %}
            </div>
            <div>
                <div class="text-lg font-bold text-white">{{ djangoq_health.status_message }}</div>
                <div class="text-sm text-gray-400">
                    –ê–∫—Ç–∏–≤–Ω—ã—Ö: {{ djangoq_health.active_tasks }} | 
                    –í –æ—á–µ—Ä–µ–¥–∏: {{ djangoq_health.queued_tasks }} | 
                    –£—Å–ø–µ—à–Ω–æ (1—á): {{ djangoq_health.recent_success }}
                    {% if djangoq_health.recent_failures > 0 %}
                    | <span class="text-red-400">–û—à–∏–±–æ–∫: {{ djangoq_health.recent_failures }}</span>
                    {% endif %}
                </div>
                {% if djangoq_health.last_task_time %}
                <div class="text-xs text-gray-500 mt-1">
                    –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–¥–∞—á–∞: {{ djangoq_health.last_task_time|timesince }} –Ω–∞–∑–∞–¥
                </div>
                {% endif %}
            </div>
        </div>
        <div class="flex gap-2">
            <a href="/admin/django_q/success/" 
               class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
                –£—Å–ø–µ—à–Ω—ã–µ
            </a>
            <a href="/admin/django_q/failure/" 
               class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm transition-colors">
                –û—à–∏–±–∫–∏
            </a>
            <a href="/admin/django_q/schedule/" 
               class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm transition-colors">
                –†–∞—Å–ø–∏—Å–∞–Ω–∏—è
            </a>
        </div>
    </div>
</div>

<script>
// AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
function refreshGigaChatBalance() {
    console.log('Refreshing GigaChat balance...');
    // TODO: Implement AJAX refresh
    location.reload();
}

// –î–µ—Ç–∞–ª–∏ –º–æ–¥–µ–ª–∏
function showModelDetails(modelKey) {
    console.log('Show details for:', modelKey);
    // TODO: Modal —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–æ–¥–µ–ª–∏
}

// Chart.js –≥—Ä–∞—Ñ–∏–∫
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('modelsUsageChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {{ usage_history|safe }},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#fff'
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
    }
});

// Auto-refresh –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(function() {
    refreshGigaChatBalance();
}, 300000);
</script>
