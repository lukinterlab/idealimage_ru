{% extends 'base_tailwind.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 dark:from-gray-950 dark:via-purple-950 dark:to-gray-950 py-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-4xl font-black text-white dark:text-white mb-2">
                        {% if is_create %}–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞{% endif %}
                    </h1>
                    {% if not is_create %}
                    <p class="text-xl text-gray-300 dark:text-gray-400">{{ template.name }}</p>
                    {% endif %}
                </div>
                <div class="flex gap-3">
                    {% if not is_create %}
                    <a href="{% url 'asistent:prompt_template_test' template.id %}" 
                       class="px-6 py-3 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 text-white font-semibold rounded-lg transition-colors flex items-center gap-2">
                        –¢–µ—Å—Ç
                    </a>
                    {% endif %}
                    <a href="{% url 'asistent:prompt_templates_list' %}" 
                       class="px-6 py-3 bg-white/10 hover:bg-white/20 dark:bg-white/5 dark:hover:bg-white/10 backdrop-blur-md text-white font-semibold rounded-lg transition-colors border border-white/20 dark:border-white/10 flex items-center gap-2">
                        –ù–∞–∑–∞–¥
                    </a>
                </div>
            </div>
        </div>
        
        <!-- –§–æ—Ä–º–∞ -->
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- –°–µ–∫—Ü–∏—è 1: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-white/20 dark:border-white/10 p-6">
                <h2 class="text-2xl font-bold text-white dark:text-white mb-6">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.category.label }}</label>
                        {{ form.category }}
                    </div>
                    
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.name.label }}</label>
                        {{ form.name }}
                    </div>
                    
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.description.label }}</label>
                        {{ form.description }}
                    </div>
                    
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.blog_category.label }}</label>
                        {{ form.blog_category }}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.blog_category.help_text }}</p>
                    </div>

                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.default_author.label }}</label>
                        {{ form.default_author }}
                        {% if form.default_author.help_text %}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.default_author.help_text }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è 2: –ü—Ä–æ–º–ø—Ç -->
            <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-white/20 dark:border-white/10 p-6">
                <h2 class="text-2xl font-bold text-white dark:text-white mb-6">–ü—Ä–æ–º–ø—Ç</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.template.label }}</label>
                        {{ form.template }}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.template.help_text }}</p>
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-white dark:text-white font-semibold">{{ form.variables.label }}</label>
                            <button type="button" onclick="addVariableManually()" 
                                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold rounded transition-colors">
                                + –î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
                            </button>
                        </div>
                        
                        <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –±–ª–æ–∫ —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ -->
                        <div class="p-4 bg-white/5 dark:bg-white/5 rounded-lg border border-white/10 dark:border-white/10 mb-3">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-sm text-gray-300 dark:text-gray-400">–ù–∞–π–¥–µ–Ω–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:</span>
                                <span id="variables-count" class="px-2 py-1 bg-green-600 text-white text-xs font-bold rounded">0</span>
                            </div>
                            
                            <div id="variables-visual-container" class="flex flex-wrap gap-2 mb-3">
                                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö -->
                            </div>
                            
                            <p class="text-xs text-gray-400 dark:text-gray-500">
                                üí° –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–µ –ø—Ä–æ–º–ø—Ç–∞ (–≤ —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö {–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è})
                            </p>
                        </div>
                        
                        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è Django (JSON —Ñ–æ—Ä–º–∞—Ç) -->
                        <textarea name="variables" id="id_variables" style="display:none;">{{ form.variables.value|default:'[]' }}</textarea>
                        
                        <div id="manual-variables-container" class="space-y-2 mt-3">
                            <!-- –†—É—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ –≤—Ä—É—á–Ω—É—é) -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è 3: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–≥–∏ -->
            <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-white/20 dark:border-white/10 p-6">
                <h2 class="text-2xl font-bold text-white dark:text-white mb-6">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–≥–∏</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.title_criteria.label }}</label>
                        {{ form.title_criteria }}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.title_criteria.help_text }}</p>
                    </div>
                    
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.tags_criteria.label }}</label>
                        {{ form.tags_criteria }}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.tags_criteria.help_text }}</p>
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è 4: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
            <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-white/20 dark:border-white/10 p-6">
                <h2 class="text-2xl font-bold text-white dark:text-white mb-6">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.image_source_type.label }}</label>
                        {{ form.image_source_type }}
                    </div>
                    
                    <div id="upload_field" style="display:none;">
                        <label class="block text-white dark:text-white mb-2">{{ form.uploaded_media.label }}</label>
                        {{ form.uploaded_media }}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.uploaded_media.help_text }}</p>
                    </div>
                    
                    <div id="search_field" style="display:none;">
                        <label class="block text-white dark:text-white mb-2">{{ form.image_search_criteria.label }}</label>
                        {{ form.image_search_criteria }}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.image_search_criteria.help_text }}</p>
                    </div>
                    
                    <div id="generate_field" style="display:none;">
                        <label class="block text-white dark:text-white mb-2">{{ form.image_generation_criteria.label }}</label>
                        {{ form.image_generation_criteria }}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.image_generation_criteria.help_text }}</p>
                    </div>
                    
                    <div>
                        <label class="flex items-center gap-2 text-white dark:text-white">
                            {{ form.auto_process_image }}
                            <span>{{ form.auto_process_image.label }}</span>
                        </label>
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1 ml-6">{{ form.auto_process_image.help_text }}</p>
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è 5: –ö–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-white/20 dark:border-white/10 p-6">
                <h2 class="text-2xl font-bold text-white dark:text-white mb-6">–ö–æ–Ω—Ç–µ–Ω—Ç</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.content_source_type.label }}</label>
                        {{ form.content_source_type }}
                    </div>
                    
                    <div id="content_urls_field" style="display:none;">
                        <label class="block text-white dark:text-white mb-2">{{ form.content_source_urls.label }}</label>
                        {{ form.content_source_urls }}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.content_source_urls.help_text }}</p>
                    </div>
                    
                    <div>
                        <label class="flex items-center gap-2 text-white dark:text-white">
                            {{ form.parse_first_paragraph }}
                            <span>{{ form.parse_first_paragraph.label }}</span>
                        </label>
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1 ml-6">{{ form.parse_first_paragraph.help_text }}</p>
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-white/20 dark:border-white/10 p-6">
                <h2 class="text-2xl font-bold text-white dark:text-white mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                
                <div>
                    <label class="flex items-center gap-2 text-white dark:text-white">
                        {{ form.is_active }}
                        <span>{{ form.is_active.label }}</span>
                    </label>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è 7: –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
            <div class="bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-white/20 dark:border-white/10 p-6">
                <h2 class="text-2xl font-bold text-white dark:text-white mb-6">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white dark:text-white mb-2">{{ form.change_summary.label }}</label>
                        {{ form.change_summary }}
                        {% if form.change_summary.help_text %}
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">{{ form.change_summary.help_text }}</p>
                        {% endif %}
                    </div>
                    
                    {% if versions %}
                    <div>
                        <h3 class="text-lg font-semibold text-white dark:text-white mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏</h3>
                        <ul class="space-y-2">
                            {% for version in versions %}
                            <li class="px-4 py-3 rounded-lg border border-white/10 dark:border-white/10 bg-white/5 dark:bg-white/5">
                                <div class="flex items-center justify-between flex-wrap gap-2">
                                    <div class="text-sm text-gray-200 dark:text-gray-300">
                                        <span class="font-semibold text-white">v{{ version.version }}</span>
                                        ‚Äî {{ version.created_at|date:"d.m.Y H:i" }}
                                        {% if version.created_by %}
                                            ¬∑ {{ version.created_by.get_full_name|default:version.created_by.username }}
                                        {% endif %}
                                    </div>
                                    {% if version.change_summary %}
                                    <div class="text-xs text-gray-400 dark:text-gray-500 max-w-xl">
                                        {{ version.change_summary }}
                                    </div>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% elif not is_create %}
                    <p class="text-sm text-gray-400 dark:text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex gap-4">
                <button type="submit" 
                        class="flex-1 px-8 py-4 bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white font-bold rounded-lg transition-colors">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <a href="{% url 'asistent:prompt_templates_list' %}" 
                   class="flex-1 px-8 py-4 bg-white/10 hover:bg-white/20 dark:bg-white/5 dark:hover:bg-white/10 backdrop-blur-md text-white font-bold rounded-lg transition-colors border border-white/20 dark:border-white/10 text-center">
                    –û—Ç–º–µ–Ω–∞
                </a>
            </div>
            
        </form>
        
    </div>
</div>

<script>
// ============ –ê–í–¢–û–ü–ê–†–°–ò–ù–ì –ü–ï–†–ï–ú–ï–ù–ù–´–• –ò–ó –ü–†–û–ú–ü–¢–ê ============

let detectedVariables = [];
let manualVariables = [];

// –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
const variableHints = {
    'zodiac_sign': '–ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ (–û–≤–µ–Ω, –¢–µ–ª–µ—Ü...)',
    'date': '–î–∞—Ç–∞ (05.11.2025)',
    'weekday': '–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –≤—Ç–æ—Ä–Ω–∏–∫...)',
    'season': '–°–µ–∑–æ–Ω –≥–æ–¥–∞ (–∑–∏–º–∞, –≤–µ—Å–Ω–∞, –ª–µ—Ç–æ, –æ—Å–µ–Ω—å)',
    'weather': '–ü–æ–≥–æ–¥–∞',
    'mood': '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
    'year': '–ì–æ–¥',
    'month': '–ú–µ—Å—è—Ü',
    'category': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
    'title': '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
    'name': '–ò–º—è'
};

function parseVariablesFromPrompt(text) {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ {–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ} –≤ —Ç–µ–∫—Å—Ç–µ
    const matches = text.match(/\{(\w+)\}/g);
    if (!matches) return [];
    
    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ {} —Å–∫–æ–±–∫–∏
    const variables = [...new Set(matches.map(v => v.slice(1, -1)))];
    return variables;
}

function updateVariablesDisplay() {
    const container = document.getElementById('variables-visual-container');
    const countBadge = document.getElementById('variables-count');
    
    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∏ —Ä—É—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const allVariables = [...new Set([...detectedVariables, ...manualVariables])];
    
    countBadge.textContent = allVariables.length;
    countBadge.className = allVariables.length > 0 
        ? 'px-2 py-1 bg-green-600 text-white text-xs font-bold rounded'
        : 'px-2 py-1 bg-gray-600 text-white text-xs font-bold rounded';
    
    container.innerHTML = '';
    
    if (allVariables.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 dark:text-gray-500">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {–∏–º—è_–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π} –≤ –ø—Ä–æ–º–ø—Ç–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤—Ä—É—á–Ω—É—é.</p>';
        return;
    }
    
    allVariables.forEach(varName => {
        const isAuto = detectedVariables.includes(varName);
        const isManual = manualVariables.includes(varName);
        const hint = variableHints[varName] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è';
        
        const badge = document.createElement('div');
        badge.className = `flex items-center gap-2 px-3 py-2 rounded-lg border ${
            isAuto ? 'bg-green-600/20 border-green-500/50' : 'bg-blue-600/20 border-blue-500/50'
        }`;
        
        badge.innerHTML = `
            <span class="text-white font-mono text-sm">{${varName}}</span>
            <span class="text-xs text-gray-300 dark:text-gray-400">${hint}</span>
            ${isManual ? `<button type="button" onclick="removeManualVariable('${varName}')" 
                          class="ml-2 text-red-400 hover:text-red-300 text-xs font-bold">‚úï</button>` : ''}
        `;
        
        container.appendChild(badge);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è Django
    document.getElementById('id_variables').value = JSON.stringify(allVariables);
}

function addVariableManually() {
    const varName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏ —Ü–∏—Ñ—Ä—ã):');
    if (!varName) return;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(varName)) {
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –±—É–∫–≤—ã –∏–ª–∏ _, —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã –∏ _');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    if (detectedVariables.includes(varName) || manualVariables.includes(varName)) {
        alert('–≠—Ç–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        return;
    }
    
    manualVariables.push(varName);
    updateVariablesDisplay();
}

function removeManualVariable(varName) {
    manualVariables = manualVariables.filter(v => v !== varName);
    updateVariablesDisplay();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–º–ø—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    const templateField = document.getElementById('id_template');
    const imageSourceType = document.getElementById('id_image_source_type');
    const contentSourceType = document.getElementById('id_content_source_type');
    
    if (templateField) {
        // –ê–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–∏ –≤–≤–æ–¥–µ
        templateField.addEventListener('input', function() {
            detectedVariables = parseVariablesFromPrompt(this.value);
            updateVariablesDisplay();
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        try {
            const existingVars = JSON.parse(document.getElementById('id_variables').value || '[]');
            const currentPromptVars = parseVariablesFromPrompt(templateField.value);
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∞–≤—Ç–æ –∏ —Ä—É—á–Ω—ã–µ
            detectedVariables = currentPromptVars;
            manualVariables = existingVars.filter(v => !currentPromptVars.includes(v));
            
            updateVariablesDisplay();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:', e);
        }
    }
    
    // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
    function toggleImageFields() {
        const value = imageSourceType.value;
        document.getElementById('upload_field').style.display = (value === 'upload') ? 'block' : 'none';
        document.getElementById('search_field').style.display = (value === 'search_db' || value === 'parse_web') ? 'block' : 'none';
        document.getElementById('generate_field').style.display = (value === 'generate_custom') ? 'block' : 'none';
    }
    
    function toggleContentFields() {
        const value = contentSourceType.value;
        document.getElementById('content_urls_field').style.display = (value === 'parse') ? 'block' : 'none';
    }
    
    if (imageSourceType) {
        imageSourceType.addEventListener('change', toggleImageFields);
        toggleImageFields();
    }
    
    if (contentSourceType) {
        const hybridOption = contentSourceType.querySelector('option[value="hybrid"]');
        if (hybridOption) {
            hybridOption.remove();
        }
        if (contentSourceType.value === 'hybrid') {
            contentSourceType.value = 'generate';
        }
        contentSourceType.addEventListener('change', toggleContentFields);
        toggleContentFields();
    }
});
</script>
{% endblock %}
