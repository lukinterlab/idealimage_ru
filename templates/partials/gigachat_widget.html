<div class="mb-8 bg-gradient-to-br from-purple-900/50 to-blue-900/50 backdrop-blur-md rounded-2xl p-6 border border-purple-500/30" id="gigachat-widget">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
            ü§ñ GigaChat AI –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        </h2>
        <div class="flex gap-2">
            <a href="{% url 'asistent:token_optimization' %}" 
               class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex items-center gap-2"
               data-tippy-content="–û—Ç–∫—Ä—ã—Ç—å –∞–Ω–∞–ª–∏–∑ –∑–∞—Ç—Ä–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤">
                üí∞ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
            </a>
            <button onclick="refreshGigaChatStats()" 
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition"
                    data-tippy-content="–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–æ–≤">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>
    
    <!-- –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å -->
    <div class="mb-6 p-4 bg-white/10 rounded-xl">
        <p class="text-white/70 text-sm mb-2">–ê–∫—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å:</p>
        <p class="text-2xl font-bold text-white" id="current-model">GigaChat-Max</p>
    </div>
    
    <!-- –ë–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–æ–≤ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="p-4 bg-white/10 rounded-xl">
            <p class="text-white/70 text-sm mb-1">Embeddings</p>
            <p class="text-xl font-bold text-white" id="balance-embeddings">-</p>
            <div class="mt-2 h-2 bg-white/20 rounded-full overflow-hidden">
                <div class="h-full bg-cyan-500 transition-all" id="progress-embeddings" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="p-4 bg-white/10 rounded-xl">
            <p class="text-white/70 text-sm mb-1">GigaChat Lite</p>
            <p class="text-xl font-bold text-white" id="balance-lite">-</p>
            <div class="mt-2 h-2 bg-white/20 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500 transition-all" id="progress-lite" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="p-4 bg-white/10 rounded-xl border-2 border-purple-500/50">
            <p class="text-white/70 text-sm mb-1">GigaChat Max</p>
            <p class="text-xl font-bold text-white" id="balance-max">1,000,000</p>
            <div class="mt-2 h-2 bg-white/20 rounded-full overflow-hidden">
                <div class="h-full bg-purple-500 transition-all" id="progress-max" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="p-4 bg-white/10 rounded-xl">
            <p class="text-white/70 text-sm mb-1">GigaChat Pro</p>
            <p class="text-xl font-bold text-white" id="balance-pro">50,000</p>
            <div class="mt-2 h-2 bg-white/20 rounded-full overflow-hidden">
                <div class="h-full bg-green-500 transition-all" id="progress-pro" style="width: 100%"></div>
            </div>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="text-center">
            <p class="text-white/70 text-sm">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</p>
            <p class="text-2xl font-bold text-white" id="total-requests">0</p>
        </div>
        <div class="text-center">
            <p class="text-white/70 text-sm">–£—Å–ø–µ—à–Ω–æ</p>
            <p class="text-2xl font-bold text-green-400" id="successful-requests">0</p>
        </div>
        <div class="text-center">
            <p class="text-white/70 text-sm">–û—à–∏–±–æ–∫</p>
            <p class="text-2xl font-bold text-red-400" id="failed-requests">0</p>
        </div>
        <div class="text-center">
            <p class="text-white/70 text-sm">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</p>
            <p class="text-2xl font-bold text-yellow-400" id="success-rate">0%</p>
        </div>
    </div>
    
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="p-4 bg-white/10 rounded-xl">
        <p class="text-white font-semibold mb-3">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞</p>
        <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
            <div class="flex items-center gap-2">
                <label class="text-white/70 text-sm">–ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ—Å–ª–µ:</label>
                <select id="check-frequency" onchange="updateGigaChatSettings()" 
                        class="px-3 py-2 bg-white/20 text-white rounded-lg border border-white/30">
                    <option value="1">1 –∑–∞–ø—Ä–æ—Å–∞</option>
                    <option value="5">5 –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                    <option value="10">10 –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                    <option value="20">20 –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                    <option value="50">50 –∑–∞–ø—Ä–æ—Å–æ–≤</option>
                </select>
            </div>
            
            <label class="flex items-center gap-2 text-white/70 text-sm">
                <input type="checkbox" id="auto-switch" onchange="updateGigaChatSettings()" 
                       class="w-4 h-4" checked>
                <span>–ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π</span>
            </label>
        </div>
    </div>
</div>

<script>
function refreshGigaChatStats() {
    fetch('/asistent/api/gigachat-balance/')
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'ok') {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö GigaChat:', data.message);
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å
            document.getElementById('current-model').textContent = data.current_model;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã
            const balances = data.balances;
            updateModelBalance('embeddings', 'GigaChat-Embeddings', balances, 10000000);
            updateModelBalance('lite', 'GigaChat', balances, 30000000);
            updateModelBalance('max', 'GigaChat-Max', balances, 1000000);
            updateModelBalance('pro', 'GigaChat-Pro', balances, 1000000);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            let totalRequests = 0, successfulRequests = 0, failedRequests = 0;
            data.stats.forEach(stat => {
                totalRequests += stat.total_requests;
                successfulRequests += stat.successful_requests;
                failedRequests += stat.failed_requests;
            });
            
            document.getElementById('total-requests').textContent = totalRequests;
            document.getElementById('successful-requests').textContent = successfulRequests;
            document.getElementById('failed-requests').textContent = failedRequests;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
            const successRate = totalRequests > 0 ? Math.round((successfulRequests / totalRequests) * 100) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            document.getElementById('check-frequency').value = data.check_after_requests;
            document.getElementById('auto-switch').checked = data.auto_switch_enabled;
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ GigaChat:', error));
}

function updateModelBalance(modelId, modelName, balances, maxTokens) {
    const balance = balances[modelName] || 0;
    const balanceEl = document.getElementById(`balance-${modelId}`);
    const progressEl = document.getElementById(`progress-${modelId}`);
    
    balanceEl.textContent = balance.toLocaleString('ru-RU');
    
    const percentage = (balance / maxTokens) * 100;
    progressEl.style.width = percentage + '%';
    
    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Å—Ç–∞—Ç–∫–∞
    if (percentage < 10) {
        progressEl.className = 'h-full bg-red-500 transition-all';
    } else if (percentage < 30) {
        progressEl.className = 'h-full bg-yellow-500 transition-all';
    }
}

function updateGigaChatSettings() {
    const checkFrequency = document.getElementById('check-frequency').value;
    const autoSwitch = document.getElementById('auto-switch').checked;
    
    fetch('/asistent/api/gigachat-settings-update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `check_balance_after_requests=${checkFrequency}&auto_switch_enabled=${autoSwitch}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', data);
        } else {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', data.message);
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(refreshGigaChatStats, 30000);

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', refreshGigaChatStats);
</script>

