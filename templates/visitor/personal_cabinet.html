{% extends 'base_tailwind.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        
        <!-- –ë–∞–Ω–Ω–µ—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä —á—É–∂–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞) -->
        {% if is_admin_view %}
        <div class="mb-6 bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl shadow-2xl p-6 text-white">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="flex items-start space-x-4">
                    <div class="bg-white/20 rounded-full p-3 flex-shrink-0">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold mb-1">üîç –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                        <p class="text-white/90 text-sm mb-2">
                            –í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <strong>{{ target_user.username }}</strong> (ID: {{ target_user.id }})
                        </p>
                        <div class="flex flex-wrap gap-2 text-xs">
                            <span class="px-2 py-1 bg-white/20 rounded">Email: {{ target_user.email|default:"–Ω–µ —É–∫–∞–∑–∞–Ω" }}</span>
                            <span class="px-2 py-1 bg-white/20 rounded">–î–∞—Ç–∞ —Ä–µ–≥.: {{ profile.registration|date:"d.m.Y" }}</span>
                            {% if profile.telegram_id %}
                            <span class="px-2 py-1 bg-white/20 rounded">Telegram: {{ profile.telegram_id }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <a href="{% url 'Visitor:superuser_dashboard' %}" 
                   class="flex-shrink-0 px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur rounded-lg font-semibold transition-colors whitespace-nowrap">
                    ‚Üê –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏
                </a>
            </div>
        </div>
        {% endif %}
        
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-heading font-bold text-gray-900 dark:text-white mb-2">
                üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç {% if is_admin_view %}–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ target_user.username }}{% endif %}
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                {% if is_admin_view %}
                    –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
                {% else %}
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}!
                {% endif %}
            </p>
        </div>

        <!-- –†–æ–ª–∏ –∏ —Å—Ç–∞—Ç—É—Å -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            {% if profile.is_author %}
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white shadow-lg hover:shadow-xl transition-shadow">
                <div class="text-sm font-medium mb-1">–†–æ–ª—å</div>
                <div class="text-2xl font-bold mb-2">‚úçÔ∏è –ê–≤—Ç–æ—Ä</div>
                <a href="{% url 'Visitor:role_instructions' 'author' %}" 
                   target="_blank"
                   class="inline-flex items-center text-xs text-white/80 hover:text-white transition-colors">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                </a>
            </div>
            {% endif %}
            {% if profile.is_moderator %}
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg hover:shadow-xl transition-shadow">
                <div class="text-sm font-medium mb-1">–†–æ–ª—å</div>
                <div class="text-2xl font-bold mb-2">üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</div>
                <a href="{% url 'Visitor:role_instructions' 'moderator' %}" 
                   target="_blank"
                   class="inline-flex items-center text-xs text-white/80 hover:text-white transition-colors">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                </a>
            </div>
            {% endif %}
            {% if profile.is_marketer %}
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white shadow-lg hover:shadow-xl transition-shadow">
                <div class="text-sm font-medium mb-1">–†–æ–ª—å</div>
                <div class="text-2xl font-bold mb-2">üìä –ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥</div>
                <div class="flex gap-2">
                    <a href="{% url 'Visitor:role_instructions' 'marketer' %}" 
                       target="_blank"
                       class="inline-flex items-center text-xs text-white/80 hover:text-white transition-colors">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                    </a>
                    <a href="{% url 'advertising:dashboard' %}" 
                       class="inline-flex items-center text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition-colors">
                        üéØ –†–µ–∫–ª–∞–º–∞
                    </a>
                </div>
            </div>
            {% endif %}
            {% if profile.is_admin %}
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 text-white shadow-lg hover:shadow-xl transition-shadow">
                <div class="text-sm font-medium mb-1">–†–æ–ª—å</div>
                <div class="text-2xl font-bold">‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
            </div>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–æ–ª–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–æ–ª–µ–π –ò –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫ -->
                {% if not profile.is_author and not profile.is_moderator and not profile.is_marketer and not profile.is_admin %}
                    {% if not has_pending_applications %}
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                            üéØ –°—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –∫–æ–º–∞–Ω–¥—ã
                        </h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            –ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –∏ –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º!
                        </p>
                        <a href="{% url 'Visitor:apply_role' %}" 
                           class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white font-medium rounded-lg hover:shadow-lg transition-all">
                            –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–æ–ª—å ‚Üí
                        </a>
                    </div>
                    {% else %}
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-6">
                        <h2 class="text-xl font-bold text-blue-900 dark:text-blue-400 mb-2">
                            ‚è≥ –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                        </h2>
                        <p class="text-blue-800 dark:text-blue-300">
                            –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 3 –¥–Ω–µ–π.
                        </p>
                    </div>
                    {% endif %}
                {% endif %}

                <!-- –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–æ–∫ (pending –∏ rejected) -->
                {% if role_applications %}
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                        üìã –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–æ–∫
                    </h2>
                    <div class="space-y-3">
                        {% for application in role_applications %}
                        <div class="border {% if application.status == 'pending' %}border-yellow-300 dark:border-yellow-700{% else %}border-red-300 dark:border-red-700{% endif %} rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="font-medium text-gray-900 dark:text-white">
                                        {{ application.get_role_display }}
                                    </span>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        –ü–æ–¥–∞–Ω–∞: {{ application.applied_at|date:"d.m.Y H:i" }}
                                    </p>
                                </div>
                                <span class="px-3 py-1 text-xs font-medium rounded-full
                                    {% if application.status == 'pending' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300
                                    {% else %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300{% endif %}">
                                    {% if application.status == 'pending' %}‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏{% else %}‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞{% endif %}
                                </span>
                            </div>
                            {% if application.status == 'rejected' and application.admin_response %}
                            <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                <p class="text-sm text-red-800 dark:text-red-300">
                                    <strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:</strong><br>
                                    {{ application.admin_response }}
                                </p>
                            </div>
                            {% elif application.status == 'pending' %}
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                                üí° –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É –≤ —Ç–µ—á–µ–Ω–∏–µ 3 –¥–Ω–µ–π
                            </p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ—Ä–∞ -->
                {% if profile.is_author %}
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                        üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ—Ä–∞
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{ author_posts_count }}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">–°—Ç–∞—Ç–µ–π</div>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
                            <div class="text-3xl font-bold text-red-600 dark:text-red-400">{{ total_likes }}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">–õ–∞–π–∫–æ–≤</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                            <div class="text-3xl font-bold text-green-600 dark:text-green-400">{{ comments_to_author }}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
                            <div class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">{{ total_donations }}‚ÇΩ</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">–î–æ–Ω–∞—Ç–æ–≤</div>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-lg">
                        <div class="text-sm text-gray-600 dark:text-gray-400">–ù–∞–∫–æ–ø–ª–µ–Ω–æ –ø—Ä–µ–º–∏–∏</div>
                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ total_bonus }}‚ÇΩ</div>
                    </div>
                </div>

                <!-- –ó–∞–¥–∞–Ω–∏—è AI - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤ -->
                {% if my_assignments %}
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                        üìã –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead>
                                <tr class="bg-gray-50 dark:bg-gray-900">
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–ó–∞–¥–∞–Ω–∏–µ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–°—Ç–∞—Ç—É—Å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–°—Ä–æ–∫</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–ù–∞–≥—Ä–∞–¥–∞</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                {% for assignment in my_assignments %}
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-4 py-4">
                                        <div class="font-medium text-gray-900 dark:text-white">{{ assignment.task.title }}</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">{{ assignment.task.description|truncatewords:15 }}</div>
                                    </td>
                                    <td class="px-4 py-4">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full
                                            {% if assignment.status == 'in_progress' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300
                                            {% elif assignment.status == 'completed' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300
                                            {% elif assignment.status == 'rejected_by_ai' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
                                            {% elif assignment.status == 'approved' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300
                                            {% endif %}">
                                            {{ assignment.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-900 dark:text-white">
                                        {{ assignment.task.deadline|date:"d.m.Y H:i" }}
                                        {% if assignment.task.is_overdue %}
                                        <span class="block text-xs text-red-600 dark:text-red-400">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-4 font-semibold text-gray-900 dark:text-white">{{ assignment.task.reward }} ‚ÇΩ</td>
                                    <td class="px-4 py-4">
                                        {% if assignment.status == 'in_progress' %}
                                        <button onclick="openSubmitModal{{ assignment.id }}()" 
                                                class="px-3 py-1 text-sm bg-primary hover:bg-secondary text-white rounded-lg transition-colors">
                                            –°–¥–∞—Ç—å
                                        </button>
                                        {% elif assignment.status == 'rejected_by_ai' %}
                                        <button onclick="openRejectionModal{{ assignment.id }}()" 
                                                class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                                            –ü—Ä–∏—á–∏–Ω–∞
                                        </button>
                                        {% elif assignment.status == 'completed' %}
                                        <span class="text-sm text-blue-600 dark:text-blue-400">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</span>
                                        {% elif assignment.status == 'approved' %}
                                        <span class="text-sm text-green-600 dark:text-green-400">‚úì –û–¥–æ–±—Ä–µ–Ω–æ</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è AI -->
                {% if available_tasks %}
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                        ‚≠ê –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for task in available_tasks %}
                        <div class="border border-primary dark:border-primary-600 rounded-xl p-5">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-semibold text-gray-900 dark:text-white text-lg">{{ task.title }}</h3>
                                <span class="px-2 py-1 text-xs bg-primary text-white rounded-full">
                                    {{ task.get_completions_count }}/{{ task.max_completions }}
                                </span>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">{{ task.description|truncatewords:25 }}</p>
                            <ul class="space-y-1 text-sm text-gray-700 dark:text-gray-300 mb-4">
                                <li>üìÅ {{ task.category.title|default:"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" }}</li>
                                <li>üìù –ú–∏–Ω–∏–º—É–º {{ task.required_word_count }} —Å–ª–æ–≤</li>
                                <li>üìÖ –î–æ {{ task.deadline|date:"d.m.Y H:i" }}</li>
                                <li>üí∞ <strong>{{ task.reward }} ‚ÇΩ</strong></li>
                            </ul>
                            <div class="flex gap-2">
                                <form method="post" action="{% url 'Visitor:take_task' task.id %}" class="flex-1">
                                    {% csrf_token %}
                                    <button type="submit" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium">
                                        –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
                                    </button>
                                </form>
                                <form method="post" action="{% url 'Visitor:reject_task' task.id %}" class="flex-1">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            onclick="return confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ? –û–Ω–æ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è.')"
                                            class="w-full px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-white rounded-lg transition-colors">
                                        –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è / –ë–∞–ª–∞–Ω—Å / –ë–æ–Ω—É—Å—ã -->
                {% if profile.is_author %}
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                        üìä –§–∏–Ω–∞–Ω—Å—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </h2>
                    
                    <div class="space-y-3">
                        
                        <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <button onclick="toggleAccordion('notifications-section')" 
                                    class="w-full flex items-center justify-between px-6 py-4 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üîî</span>
                                    <span class="text-lg font-bold text-gray-900 dark:text-white">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                                    {% if notifications_count > 0 %}
                                    <span class="px-3 py-1 bg-red-500 text-white rounded-full text-sm font-semibold">
                                        {{ notifications_count }} –Ω–æ–≤—ã—Ö
                                    </span>
                                    {% endif %}
                                </div>
                                <svg class="accordion-icon w-6 h-6 text-gray-600 dark:text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="notifications-section" class="accordion-content">
                                <div class="p-6 space-y-3">
                                    {% for notification in all_notifications %}
                                    <div class="border {% if not notification.is_read %}border-blue-300 dark:border-blue-700 bg-blue-50 dark:bg-blue-900/10{% else %}border-gray-200 dark:border-gray-700{% endif %} rounded-lg p-4">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <h4 class="font-semibold text-gray-900 dark:text-white mb-1">
                                                    {% if notification.notification_type == 'moderation_passed' %}‚úÖ
                                                    {% elif notification.notification_type == 'moderation_failed' %}‚ùå
                                                    {% elif notification.notification_type == 'task_approved' %}‚úÖ
                                                    {% elif notification.notification_type == 'task_rejected' %}‚ùå
                                                    {% elif notification.notification_type == 'payment' %}üí∞
                                                    {% else %}‚ÑπÔ∏è{% endif %}
                                                    {{ notification.title }}
                                                </h4>
                                                <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line mb-2">{{ notification.message }}</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                                    {{ notification.created_at|date:"d.m.Y H:i" }}
                                                </p>
                                            </div>
                                            {% if not notification.is_read %}
                                            <button onclick="markNotificationRead({{ notification.id }})"
                                                    class="ml-3 px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                                –ü—Ä–æ—á–∏—Ç–∞–Ω–æ
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <p class="text-center text-gray-500 dark:text-gray-400 py-8">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                                    {% endfor %}
                                    
                                    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è AJAX -->
                                    <div id="notifications-pagination"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω: –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞ -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <button onclick="toggleAccordion('balance-section')" 
                                    class="w-full flex items-center justify-between px-6 py-4 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üíº</span>
                                    <span class="text-lg font-bold text-gray-900 dark:text-white">–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞</span>
                                    <span class="px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full text-sm font-semibold">
                                        {{ balance }}‚ÇΩ
                                    </span>
                                </div>
                                <svg class="accordion-icon w-6 h-6 text-gray-600 dark:text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="balance-section" class="accordion-content">
                                <div class="p-6">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                            <thead>
                                                <tr class="bg-gray-50 dark:bg-gray-900">
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–î–∞—Ç–∞</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–¢–∏–ø</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–°—É–º–º–∞</th>
                                                </tr>
                                            </thead>
                                            <tbody id="balance-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                                {% for transaction in recent_transactions %}
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                    <td class="px-4 py-4 text-sm text-gray-900 dark:text-white">
                                                        {{ transaction.created_at|date:"d.m.Y H:i" }}
                                                    </td>
                                                    <td class="px-4 py-4">
                                                        <span class="px-2 py-1 text-xs font-medium rounded-full
                                                            {% if transaction.transaction_type == 'task_payment' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300
                                                            {% elif transaction.transaction_type == 'bonus_payment' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300
                                                            {% elif transaction.transaction_type == 'withdrawal' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
                                                            {% endif %}">
                                                            {{ transaction.get_transaction_type_display }}
                                                        </span>
                                                    </td>
                                                    <td class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300">
                                                        {{ transaction.description }}
                                                    </td>
                                                    <td class="px-4 py-4 font-semibold 
                                                        {% if transaction.amount > 0 %}text-green-600 dark:text-green-400
                                                        {% else %}text-red-600 dark:text-red-400{% endif %}">
                                                        {% if transaction.amount > 0 %}+{% endif %}{{ transaction.amount }} ‚ÇΩ
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td></tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="balance-pagination" class="mt-4"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω: –ë–æ–Ω—É—Å—ã -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <button onclick="toggleAccordion('bonuses-section')" 
                                    class="w-full flex items-center justify-between px-6 py-4 bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üí∞</span>
                                    <span class="text-lg font-bold text-gray-900 dark:text-white">–ú–æ–∏ –±–æ–Ω—É—Å—ã</span>
                                    <span class="px-3 py-1 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded-full text-sm font-semibold">
                                        {{ total_bonus }}‚ÇΩ
                                    </span>
                                </div>
                                <svg class="accordion-icon w-6 h-6 text-gray-600 dark:text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="bonuses-section" class="accordion-content">
                                <div class="p-6">
                                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ–Ω—É—Å–æ–≤ -->
                                    <div class="grid grid-cols-3 gap-4 mb-6">
                                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
                                            <p class="text-sm text-gray-600 dark:text-gray-400">–í—Å–µ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ</p>
                                            <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ bonuses_stats.total }}‚ÇΩ</p>
                                        </div>
                                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                                            <p class="text-sm text-gray-600 dark:text-gray-400">–í—ã–ø–ª–∞—á–µ–Ω–æ</p>
                                            <p class="text-2xl font-bold text-green-600 dark:text-green-400">{{ bonuses_stats.paid }}‚ÇΩ</p>
                                        </div>
                                        <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 text-center">
                                            <p class="text-sm text-gray-600 dark:text-gray-400">–ö –≤—ã–ø–ª–∞—Ç–µ</p>
                                            <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ bonuses_stats.pending }}‚ÇΩ</p>
                                        </div>
                                    </div>
                                    
                                    <!-- –¢–∞–±–ª–∏—Ü–∞ –±–æ–Ω—É—Å–æ–≤ -->
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                            <thead>
                                                <tr class="bg-gray-50 dark:bg-gray-900">
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–ù–µ–¥–µ–ª—è</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–î–∞—Ç–∞</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–°—É–º–º–∞</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–°—Ç–∞—Ç—É—Å</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">–î–µ—Ç–∞–ª–∏</th>
                                                </tr>
                                            </thead>
                                            <tbody id="bonuses-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                                {% for bonus in recent_bonuses %}
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                    <td class="px-4 py-4 text-sm text-gray-900 dark:text-white">
                                                        {{ bonus.period_start|date:"d.m" }} - {{ bonus.period_end|date:"d.m.Y" }}
                                                    </td>
                                                    <td class="px-4 py-4 text-sm text-gray-900 dark:text-white">
                                                        {{ bonus.created_at|date:"d.m.Y H:i" }}
                                                    </td>
                                                    <td class="px-4 py-4 font-semibold text-purple-600 dark:text-purple-400">
                                                        {{ bonus.total_bonus }} ‚ÇΩ
                                                    </td>
                                                    <td class="px-4 py-4">
                                                        <span class="px-2 py-1 text-xs font-medium rounded-full
                                                            {% if bonus.status == 'paid' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300
                                                            {% elif bonus.status == 'pending' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300
                                                            {% elif bonus.status == 'cancelled' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
                                                            {% endif %}">
                                                            {{ bonus.get_status_display }}
                                                        </span>
                                                    </td>
                                                    <td class="px-4 py-4">
                                                        <button onclick="openBonusDetailsModal({{ bonus.id }})"
                                                                class="px-3 py-1 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                                                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">–ù–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</td></tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="bonuses-pagination" class="mt-4"></div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                {% endif %}


                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å—Ç–∞—Ç—å—è–º -->               
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                        üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –≤–∞—à–∏–º —Å—Ç–∞—Ç—å—è–º
                    </h2>
                    {% if recent_comments_to_posts %}
                    <div class="space-y-4">
                        {% for comment in recent_comments_to_posts %}
                        <div class="border-l-4 border-primary pl-4 py-2">
                            <p class="text-gray-900 dark:text-white mb-2">{{ comment.content|truncatewords:20 }}</p>
                            <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
                                <span>{{ comment.author_comment }}</span>
                                <span>‚Ä¢</span>
                                <span>{{ comment.created|date:"d.m.Y H:i" }}</span>
                                <span>‚Ä¢</span>
                                <a href="{% url 'blog:post_detail' comment.post.slug %}" 
                                   class="text-primary hover:underline">
                                    {{ comment.post.title }}
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <a href="{% url 'Visitor:author_comments' %}" 
                       class="inline-block mt-4 text-primary hover:underline">
                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ‚Üí
                    </a>
                    {% endif %}
                </div>
                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å—Ç–∞—Ç—å—è–º –∫–æ–Ω–µ—Ü-->

              
                <!-- –ú–æ–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                        üí≠ –ú–æ–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                    </h2>
                    {% if user_comments %}
                    <div class="space-y-3">
                        {% for comment in user_comments %}
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <p class="text-gray-900 dark:text-white mb-2">{{ comment.content|truncatewords:15 }}</p>
                            <a href="{% url 'blog:post_detail' comment.post.slug %}" 
                               class="text-sm text-primary hover:underline">
                                {{ comment.post.title }}
                            </a>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                {{ comment.created|date:"d.m.Y H:i" }}
                            </p>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <!-- –ú–æ–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫–æ–Ω–µ—Ü-->

            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="space-y-6">

                <!-- –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –∞–≤—Ç–æ—Ä–∞ -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                        üë• –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ ({{ subscribers_count }})
                    </h2>
                    {% if subscribers_count > 0 %}
                    <div class="space-y-2">
                        {% for subscription in subscribers|slice:":10" %}
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <img src="{{ subscription.subscriber.profile.get_avatar }}" 
                                 alt="{{ subscription.subscriber.username }}"
                                 class="w-10 h-10 rounded-full">
                            <div>
                                <a href="{% url 'Visitor:profile_detail' subscription.subscriber.profile.slug %}"
                                   class="font-medium text-gray-900 dark:text-white hover:text-primary">
                                    {{ subscription.subscriber.username }}
                                </a>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    –° {{ subscription.created_at|date:"d.m.Y" }}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <!-- –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –∞–≤—Ç–æ—Ä–∞ –∫–æ–Ω–µ—Ü-->
                
                <!-- –ü–æ–¥–ø–∏—Å–∫–∏ -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                        ‚≠ê –ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏ ({{ subscriptions_count }})
                    </h2>
                    {% if subscriptions %}
                    <div class="space-y-3">
                        {% for subscription in subscriptions|slice:":5" %}
                        <div class="flex items-center space-x-3">
                            <img src="{{ subscription.author.profile.get_avatar }}" 
                                 alt="{{ subscription.author.username }}"
                                 class="w-10 h-10 rounded-full">
                            <div class="flex-1">
                                <a href="{% url 'Visitor:profile_detail' subscription.author.profile.slug %}"
                                   class="font-medium text-gray-900 dark:text-white hover:text-primary block">
                                    {{ subscription.author.username }}
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500 dark:text-gray-400 text-sm">
                        –í—ã –µ—â–µ –Ω–∏ –Ω–∞ –∫–æ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã
                    </p>
                    {% endif %}
                </div>

                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ –∏–∑ –ø–æ–¥–ø–∏—Å–æ–∫ -->
                {% if subscribed_posts %}
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                        üì∞ –ù–æ–≤–æ–µ –æ—Ç –∞–≤—Ç–æ—Ä–æ–≤
                    </h2>
                    <div class="space-y-4">
                        {% for post in subscribed_posts|slice:":5" %}
                        <div>
                            <a href="{% url 'blog:post_detail' post.slug %}"
                               class="font-medium text-gray-900 dark:text-white hover:text-primary block mb-1">
                                {{ post.title|truncatewords:8 }}
                            </a>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                {{ post.author.username }} ‚Ä¢ {{ post.created|date:"d.m.Y" }}
                            </p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                        ‚ö° {% if is_admin_view %}–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% else %}–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è{% endif %}
                    </h2>
                    
                    {% if is_admin_view %}
                    <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg text-sm text-blue-800 dark:text-blue-300">
                        <strong>‚ÑπÔ∏è –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è. 
                        –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ —Å –æ—Ä–∞–Ω–∂–µ–≤—ã–º —Ü–≤–µ—Ç–æ–º –Ω–∏–∂–µ.
                    </div>
                    {% endif %}
                    
                    <div class="space-y-2">
                        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–î–û–°–¢–£–ü–ù–´ –í–°–ï–ì–î–ê –¥–ª—è —Å—É–ø–µ—Ä—é–∑–µ—Ä–∞) -->
                        <a href="{% url 'Visitor:profile_edit' %}" 
                           class="block px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å {% if is_admin_view %}–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% endif %}
                        </a>
                        
                        <!-- –ù–∞–ø–∏—Å–∞—Ç—å —Å—Ç–∞—Ç—å—é (–í–°–ï–ì–î–ê –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å—É–ø–µ—Ä—é–∑–µ—Ä–∞) -->
                        {% if profile.is_author or is_admin_view or user.is_superuser %}
                        <a href="{% url 'blog:post_create' %}" 
                           class="block px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            üìù –ù–∞–ø–∏—Å–∞—Ç—å —Å—Ç–∞—Ç—å—é
                        </a>
                        {% endif %}
                        
                        <!-- –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–æ–ª—å (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç —Ä–æ–ª–µ–π) -->
                        {% if not profile.is_author and not profile.is_moderator and not profile.is_marketer and not profile.is_admin and not has_pending_applications %}
                        <a href="{% url 'Visitor:apply_role' %}" 
                           class="block px-4 py-2 text-primary dark:text-primary-400 font-medium hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            üéØ –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–æ–ª—å
                        </a>
                        {% endif %}
                        
                        <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è -->
                        <a href="{% url 'Visitor:profile_detail' profile.slug %}" 
                           target="_blank"
                           class="block px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            üëÅÔ∏è –ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
                        </a>
                        
                        <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∞–≤—Ç–æ—Ä–∞ -->
                        {% if profile.is_author or is_admin_view %}
                        <a href="{% url 'Visitor:author_comments' %}" 
                           class="block px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å—Ç–∞—Ç—å—è–º
                        </a>
                        {% endif %}
                        
                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                        {% if is_admin_view %}
                            <hr class="my-2 border-gray-200 dark:border-gray-700">
                            <div class="text-xs font-semibold text-orange-600 dark:text-orange-400 px-4 py-2 bg-orange-50 dark:bg-orange-900/20 rounded">
                                üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:
                            </div>
                            <a href="{% url 'admin:auth_user_change' target_user.id %}" 
                               target="_blank"
                               class="block px-4 py-2 text-orange-600 dark:text-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors font-medium">
                                ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                            </a>
                            <a href="{% url 'admin:Visitor_profile_change' profile.id %}" 
                               target="_blank"
                               class="block px-4 py-2 text-orange-600 dark:text-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors font-medium">
                                üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º
                            </a>
                            <a href="{% url 'admin:blog_post_changelist' %}?author__id={{ target_user.id }}" 
                               target="_blank"
                               class="block px-4 py-2 text-orange-600 dark:text-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors font-medium">
                                üì∞ –í—Å–µ —Å—Ç–∞—Ç—å–∏ –∞–≤—Ç–æ—Ä–∞ (–∞–¥–º–∏–Ω–∫–∞)
                            </a>
                            <a href="{% url 'Visitor:superuser_dashboard' %}" 
                               class="block px-4 py-2 text-orange-600 dark:text-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors font-medium">
                                ‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏
                            </a>
                        {% endif %}
                        
                        <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–≤ —Å–≤–æ–µ–º –∫–∞–±–∏–Ω–µ—Ç–µ) -->
                        {% if user.is_superuser and not is_admin_view %}
                        <hr class="my-2 border-gray-200 dark:border-gray-700">
                        <a href="{% url 'Visitor:superuser_dashboard' %}" 
                           class="block px-4 py-2 text-orange-600 dark:text-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors font-medium">
                            ‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                        </a>
                        <a href="{% url 'asistent:admin_dashboard' %}" 
                           class="block px-4 py-2 text-orange-600 dark:text-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors font-medium">
                            ‚öôÔ∏è –ü–∞–Ω–µ–ª—å A–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—ÄA
                        </a>
                        <a href="/dashboard/" 
                           class="block px-4 py-2 text-orange-600 dark:text-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors font-medium">
                            ‚öôÔ∏è –ü–∞–Ω–µ–ª—å A–¥–º–∏–Ω–∏A
                        </a>
                        {% endif %}
                    </div>
                </div>

            </div>

        </div>

    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Å–¥–∞—á–∏ –∑–∞–¥–∞–Ω–∏–π -->
{% if my_assignments %}
{% for assignment in my_assignments %}
{% if assignment.status == 'in_progress' %}
<div id="submitModal{{ assignment.id }}" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            –°–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ: {{ assignment.task.title }}
        </h3>
        <form method="post" action="{% url 'Visitor:submit_assignment' assignment.id %}">
            {% csrf_token %}
            <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <p class="text-sm text-blue-800 dark:text-blue-300">
                    AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à—É —Å—Ç–∞—Ç—å—é –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏—è–º –∑–∞–¥–∞–Ω–∏—è.
                </p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ID —Å—Ç–∞—Ç—å–∏</label>
                <input type="number" name="article_id" required
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">–í–≤–µ–¥–∏—Ç–µ ID –≤–∞—à–µ–π –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–∏</p>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeSubmitModal{{ assignment.id }}()"
                        class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-white rounded-lg transition-colors">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit"
                        class="flex-1 px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors font-medium">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function openSubmitModal{{ assignment.id }}() {
    document.getElementById('submitModal{{ assignment.id }}').classList.remove('hidden');
}
function closeSubmitModal{{ assignment.id }}() {
    document.getElementById('submitModal{{ assignment.id }}').classList.add('hidden');
}
</script>
{% endif %}

{% if assignment.status == 'rejected_by_ai' %}
<div id="rejectionModal{{ assignment.id }}" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-2xl w-full p-6">
        <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4">
            –ó–∞–º–µ—á–∞–Ω–∏—è AI: {{ assignment.task.title }}
        </h3>
        <div class="mb-4 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
            <p class="font-medium text-red-800 dark:text-red-300">–°—Ç–∞—Ç—å—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
            {% if assignment.ai_moderation_result %}
            <p class="text-2xl font-bold text-red-600 dark:text-red-400 mt-2">
                –û—Ü–µ–Ω–∫–∞: {{ assignment.ai_moderation_result.score|default:"?" }}/10
            </p>
            {% endif %}
        </div>
        <div class="mb-4">
            <h4 class="font-medium text-gray-900 dark:text-white mb-2">–ó–∞–º–µ—á–∞–Ω–∏—è:</h4>
            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <p class="text-gray-900 dark:text-white whitespace-pre-line">{{ assignment.rejection_reason }}</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button type="button" onclick="closeRejectionModal{{ assignment.id }}()"
                    class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-white rounded-lg transition-colors">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
            {% if assignment.article %}
            <a href="{% url 'blog:post_update' assignment.article.slug %}" target="_blank"
               class="flex-1 text-center px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors font-medium">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é
            </a>
            {% endif %}
        </div>
    </div>
</div>

<script>
function openRejectionModal{{ assignment.id }}() {
    document.getElementById('rejectionModal{{ assignment.id }}').classList.remove('hidden');
}
function closeRejectionModal{{ assignment.id }}() {
    document.getElementById('rejectionModal{{ assignment.id }}').classList.add('hidden');
}
</script>
{% endif %}
{% endfor %}
{% endif %}

<!-- –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ -->
<style>
.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.accordion-content.open {
    max-height: 3000px;
    transition: max-height 0.5s ease-in;
}
</style>

<!-- JavaScript –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –∏ AJAX -->
<script>
// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
function toggleAccordion(id) {
    const content = document.getElementById(id);
    const header = content.previousElementSibling;
    const icon = header.querySelector('.accordion-icon');
    
    if (content.classList.contains('open')) {
        content.classList.remove('open');
        icon.classList.remove('rotate-180');
    } else {
        content.classList.add('open');
        icon.classList.add('rotate-180');
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCsrfToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue;
}

// –û—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
async function markNotificationRead(notificationId) {
    try {
        const response = await fetch(`/notifications/${notificationId}/read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –±–æ–Ω—É—Å–∞
async function openBonusDetailsModal(bonusId) {
    try {
        const response = await fetch(`/api/bonuses/${bonusId}/`);
        const data = await response.json();
        
        // –°–æ–∑–¥–∞—ë–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        modal.id = 'bonusDetailsModal';
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full p-6">
                <h3 class="text-xl font-bold text-purple-600 dark:text-purple-400 mb-4">
                    –î–µ—Ç–∞–ª–∏ –±–æ–Ω—É—Å–∞: ${data.week}
                </h3>
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                        <span class="text-gray-700 dark:text-gray-300">–û–±—â–∞—è —Å—É–º–º–∞:</span>
                        <span class="text-xl font-bold text-purple-600 dark:text-purple-400">${data.total_bonus} ‚ÇΩ</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <span class="text-gray-700 dark:text-gray-300">–ë–æ–Ω—É—Å –æ—Ç –¥–æ–Ω–∞—Ç–æ–≤:</span>
                        <span class="font-semibold text-gray-900 dark:text-white">${data.details.calculated_bonus} ‚ÇΩ</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <span class="text-gray-700 dark:text-gray-300">–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ –∑–∞–¥–∞–Ω–∏—è:</span>
                        <span class="font-semibold text-gray-900 dark:text-white">${data.details.tasks_reward} ‚ÇΩ</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <span class="text-gray-700 dark:text-gray-300">–ë–æ–Ω—É—Å –∏–∑ –±–∞–ª–ª–æ–≤:</span>
                        <span class="font-semibold text-gray-900 dark:text-white">${data.details.bonus_from_points} ‚ÇΩ</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <span class="text-gray-700 dark:text-gray-300">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –±–∞–ª–ª–æ–≤:</span>
                        <span class="font-semibold text-gray-900 dark:text-white">${data.details.points_earned}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <span class="text-gray-700 dark:text-gray-300">–°—Ç–∞—Ç—É—Å:</span>
                        <span class="text-sm font-medium">${data.status}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <span class="text-gray-700 dark:text-gray-300">–î–∞—Ç–∞:</span>
                        <span class="text-sm">${data.created_at}</span>
                    </div>
                </div>
                <button onclick="closeBonusDetailsModal()"
                        class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeBonusDetailsModal();
            }
        });
    } catch (error) {
        console.error('Error loading bonus details:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –±–æ–Ω—É—Å–∞');
    }
}

function closeBonusDetailsModal() {
    const modal = document.getElementById('bonusDetailsModal');
    if (modal) {
        modal.remove();
    }
}
</script>
{% endblock %}

