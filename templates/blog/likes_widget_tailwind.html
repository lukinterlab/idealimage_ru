{% load static %}

<div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl p-6 my-8" id="likes-widget-{{ post.id }}">
    
    
    <!-- Reactions -->
    <div class="flex items-center justify-center flex-wrap gap-4 py-4">
        <!-- Like Button -->
        <button class="reaction-btn flex flex-col items-center group" 
                data-reaction="like" 
                data-post-id="{{ post.id }}"
                onclick="toggleReaction(this, 'like')">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-pink-400 to-pink-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-200 reaction-icon">
                <span class="text-3xl">üëç</span>
            </div>
            <span class="mt-2 text-sm font-semibold text-gray-700 group-hover:text-pink-500 transition-colors">–ù—Ä–∞–≤–∏—Ç—Å—è</span>
            <span class="text-xs text-gray-500 reaction-count" data-type="like">0</span>
        </button>

        <!-- Love Button -->
        <button class="reaction-btn flex flex-col items-center group" 
                data-reaction="love" 
                data-post-id="{{ post.id }}"
                onclick="toggleReaction(this, 'love')">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-200 reaction-icon">
                <span class="text-3xl">‚ù§Ô∏è</span>
            </div>
            <span class="mt-2 text-sm font-semibold text-gray-700 group-hover:text-red-500 transition-colors">–õ—é–±–ª—é</span>
            <span class="text-xs text-gray-500 reaction-count" data-type="love">0</span>
        </button>

        <!-- Laugh Button -->
        <button class="reaction-btn flex flex-col items-center group" 
                data-reaction="laugh" 
                data-post-id="{{ post.id }}"
                onclick="toggleReaction(this, 'laugh')">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-200 reaction-icon">
                <span class="text-3xl">üòÇ</span>
            </div>
            <span class="mt-2 text-sm font-semibold text-gray-700 group-hover:text-yellow-600 transition-colors">–°–º–µ—à–Ω–æ</span>
            <span class="text-xs text-gray-500 reaction-count" data-type="laugh">0</span>
        </button>

        <!-- Wow Button -->
        <button class="reaction-btn flex flex-col items-center group" 
                data-reaction="wow" 
                data-post-id="{{ post.id }}"
                onclick="toggleReaction(this, 'wow')">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-200 reaction-icon">
                <span class="text-3xl">üòÆ</span>
            </div>
            <span class="mt-2 text-sm font-semibold text-gray-700 group-hover:text-purple-600 transition-colors">–í–∞—É!</span>
            <span class="text-xs text-gray-500 reaction-count" data-type="wow">0</span>
        </button>

        <!-- Sad Button -->
        <button class="reaction-btn flex flex-col items-center group" 
                data-reaction="sad" 
                data-post-id="{{ post.id }}"
                onclick="toggleReaction(this, 'sad')">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-200 reaction-icon">
                <span class="text-3xl">üò¢</span>
            </div>
            <span class="mt-2 text-sm font-semibold text-gray-700 group-hover:text-blue-500 transition-colors">–ì—Ä—É—Å—Ç–Ω–æ</span>
            <span class="text-xs text-gray-500 reaction-count" data-type="sad">0</span>
        </button>

        <!-- Angry Button -->
        <button class="reaction-btn flex flex-col items-center group" 
                data-reaction="angry" 
                data-post-id="{{ post.id }}"
                onclick="toggleReaction(this, 'angry')">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-200 reaction-icon">
                <span class="text-3xl">üò†</span>
            </div>
            <span class="mt-2 text-sm font-semibold text-gray-700 group-hover:text-orange-600 transition-colors">–ó–ª—é—Å—å</span>
            <span class="text-xs text-gray-500 reaction-count" data-type="angry">0</span>
        </button>
    </div>
    
    <!-- Total Reactions
    <div class="text-center mt-4 pt-4 border-t border-gray-300">
        <p class="text-sm text-gray-600">
            –í—Å–µ–≥–æ —Ä–µ–∞–∫—Ü–∏–π: <span class="font-bold text-primary" id="total-reactions">{{ post.get_likes_count }}</span>
        </p>
    </div> -->
</div>

<style>
.reaction-btn.active .reaction-icon {
    transform: scale(1.2);
    box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.3);
}
</style>

<script>
// –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
function getCSRFToken() {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—É–∫–∏
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 'csrftoken='.length) === 'csrftoken=') {
                cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
                break;
            }
        }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –∫—É–∫–∏, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ input
    if (!cookieValue) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    
    return cookieValue;
}

const csrftoken = getCSRFToken();
console.log('CSRF Token:', csrftoken);
console.log('CSRF Token length:', csrftoken ? csrftoken.length : 0);

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
async function toggleReaction(button, reactionType) {
    const postId = button.getAttribute('data-post-id');
    const icon = button.querySelector('.reaction-icon');
    
    console.log('Post ID:', postId);
    console.log('Reaction Type:', reactionType);
    console.log('CSRF Token:', csrftoken);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è
    icon.classList.add('animate-bounce');
    setTimeout(() => icon.classList.remove('animate-bounce'), 500);
    
    try {
        const response = await fetch(`/blog/api/post/${postId}/like/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                reaction_type: reactionType
            })
        });
        
        console.log('Response status:', response.status);
        console.log('Response URL:', response.url);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateReactionsUI(data, postId);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(data.action, reactionType);
        } else {
            console.error('API Error:', data.error);
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('Fetch Error:', error);
        console.error('Error details:', error.message);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∞–∫—Ü–∏–∏: ' + error.message);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Ä–µ–∞–∫—Ü–∏–π
function updateReactionsUI(data, postId) {
    // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∞–∫—Ü–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞—Ç—å–∏
    const reactionsContainer = document.getElementById(`likes-widget-${postId}`);
    if (!reactionsContainer) return;
    
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
    reactionsContainer.querySelectorAll('.reaction-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—ã–¥–µ–ª—è–µ–º –µ—ë
    if (data.user_reaction) {
        const activeBtn = reactionsContainer.querySelector(`[data-reaction="${data.user_reaction}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
    reactionsContainer.querySelectorAll('.reaction-count').forEach(el => {
        el.textContent = '0';
    });
    
    data.likes_by_type.forEach(item => {
        const countEl = reactionsContainer.querySelector(`.reaction-count[data-type="${item.reaction_type}"]`);
        if (countEl) {
            countEl.textContent = item.count;
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const totalReactionsEl = reactionsContainer.querySelector('#total-reactions');
    if (totalReactionsEl) {
        totalReactionsEl.textContent = data.likes_count;
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(action, reactionType) {
    const messages = {
        'added': '–†–µ–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!',
        'updated': '–†–µ–∞–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞!',
        'removed': '–†–µ–∞–∫—Ü–∏—è —É–±—Ä–∞–Ω–∞'
    };
    
    // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤–æ–µ)
    const notification = document.createElement('div');
    notification.className = 'fixed top-20 right-4 bg-primary text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
    notification.textContent = messages[action] || '–ì–æ—Ç–æ–≤–æ!';
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('opacity-0', 'transition-opacity');
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const allReactionButtons = document.querySelectorAll('.reaction-btn');
    
    for (const button of allReactionButtons) {
        const postId = button.getAttribute('data-post-id');
        if (!postId) continue;
        
        try {
            const response = await fetch(`/blog/api/post/${postId}/stats/`);
            const data = await response.json();
            
            if (data.success) {
                updateReactionsUI({
                    user_reaction: data.likes.user_reaction,
                    likes_by_type: data.likes.by_type,
                    likes_count: data.likes.count
                }, postId);
            }
        } catch (error) {
            console.error(`Error loading reactions for post ${postId}:`, error);
        }
    }
});
</script>
